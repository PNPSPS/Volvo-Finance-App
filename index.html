<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volvo Finance Service (Admin Mode)</title>
    
    <!-- 1. โหลด Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style> 
        body { font-family: 'Prompt', sans-serif; background-color: #f1f5f9; }
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; color: #64748b; }
        .error-box { padding: 20px; background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; margin: 20px; border-radius: 8px; font-family: monospace; }
        #root { min-height: 100vh; }
    </style>

    <!-- 2. โหลด Libraries จากแหล่งที่เสถียรที่สุด (Cloudflare) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- 3. โหลด Firebase Compat (จำเป็นสำหรับไฟล์เดี่ยว) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="error-display"></div>
    <div id="root"></div>

    <!-- ปุ่มฉุกเฉินสำหรับล้างค่า -->
    <button onclick="localStorage.removeItem('vfs_firebase_config'); window.location.reload();" style="position: fixed; bottom: 10px; right: 10px; opacity: 0.5; font-size: 10px; background: #eee; border: none; padding: 5px; cursor: pointer; z-index: 9999;">
        Reset Config (Emergency)
    </button>

    <script>
        // ระบบดักจับ Error ก่อนเริ่มโปรแกรม (ป้องกันจอขาว)
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-display').innerHTML = `
                <div class="error-box">
                    <h3>⚠️ เกิดข้อผิดพลาด (System Error)</h3>
                    <p><b>Message:</b> ${message}</p>
                    <p><b>Source:</b> ${source}:${lineno}</p>
                    <p>กรุณาแคปหน้าจอนี้ส่งให้ผู้ดูแลระบบ</p>
                    <button onclick="localStorage.clear(); window.location.reload();" style="margin-top:10px; padding:5px 10px;">ลองกดปุ่มนี้เพื่อล้างค่า (Clear Data)</button>
                </div>
            `;
            return true;
        };
    </script>

    <script type="text/babel">
        // ตรวจสอบความพร้อมของ Library
        if (!window.React || !window.ReactDOM || !window.firebase) {
            throw new Error("โหลดเครื่องมือไม่ครบ (Internet อาจมีปัญหา หรือโดนบล็อก)");
        }

        const { useState, useEffect, useMemo } = React;

        // --- Icons (SVG) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                settings: <path d="M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
                user: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
                lock: <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></g>,
                building: <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18 M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2 M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2 M10 6h4 M10 10h4 M10 14h4 M10 18h4" />,
                logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />,
                plus: <g><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></g>,
                minus: <line x1="5" y1="12" x2="19" y2="12" />,
                wallet: <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4h-4z" />,
                users: <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M16 3.13a4 4 0 0 1 0 7.75" />,
                trash: <g><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></g>,
                refresh: <g><polyline points="23 4 23 10 17 10" /><polyline points="1 20 1 14 7 14" /><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></g>,
                x: <g><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></g>,
                check: <polyline points="20 6 9 17 4 12" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- Config Screen ---
        const ConfigScreen = ({ onSave }) => {
            const [input, setInput] = useState('');
            const [err, setErr] = useState('');

            const save = () => {
                try {
                    let clean = input.trim().replace(/^(const|var|let)\s+firebaseConfig\s*=\s*/, '').replace(/;$/, '');
                    let json;
                    try { json = JSON.parse(clean); } 
                    catch { json = new Function('return ' + clean)(); }
                    
                    if (!json || !json.apiKey) throw new Error("ไม่พบ apiKey");
                    onSave(json);
                } catch (e) {
                    setErr('รูปแบบไม่ถูกต้อง: ก๊อปปี้มาทั้งบรรทัด const firebaseConfig = { ... } เลยครับ');
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                        <h2 className="text-xl font-bold mb-4 text-center">ตั้งค่าการเชื่อมต่อ</h2>
                        <textarea className="w-full h-40 p-3 border rounded mb-4 text-xs font-mono" 
                            placeholder='วางโค้ด firebaseConfig ที่นี่...' 
                            value={input} onChange={e=>setInput(e.target.value)}></textarea>
                        {err && <div className="text-red-500 text-xs mb-2">{err}</div>}
                        <button onClick={save} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">บันทึก</button>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [config, setConfig] = useState(() => {
                try {
                    const saved = localStorage.getItem('vfs_firebase_config');
                    return saved ? JSON.parse(saved) : null;
                } catch { return null; }
            });

            const [init, setInit] = useState(false);
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            
            // UI State
            const [view, setView] = useState('dashboard'); 
            const [modals, setModals] = useState({ register: false, request: false, deposit: false, manage: false, adminAuth: false });
            const [profiles, setProfiles] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [requests, setRequests] = useState([]);
            const [inputs, setInputs] = useState({});
            const [selectedProfile, setSelectedProfile] = useState(null);

            // 1. Initialize Firebase
            useEffect(() => {
                if (!config) return;
                try {
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    
                    const auth = firebase.auth();
                    const db = firebase.firestore();
                    
                    auth.onAuthStateChanged(u => {
                        if (!u) auth.signInAnonymously().catch(e => alert("Auth Error: " + e.message));
                        setUser(u);
                    });

                    setInit(true);
                } catch (e) {
                    alert("Firebase Init Failed: " + e.message);
                    localStorage.removeItem('vfs_firebase_config');
                    window.location.reload();
                }
            }, [config]);

            // 2. Data Listening
            useEffect(() => {
                if (!user || !init) return;
                const db = firebase.firestore();
                const appId = 'volvo-finance';

                const unsubUsers = db.collection('app_data').doc(appId).collection('users').onSnapshot(snap => {
                    setProfiles(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                const unsubTx = db.collection('app_data').doc(appId).collection('transactions')
                    .orderBy('createdAt', 'desc').limit(50).onSnapshot(snap => {
                    setTransactions(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                const unsubReq = db.collection('app_data').doc(appId).collection('requests')
                    .orderBy('createdAt', 'desc').limit(50).onSnapshot(snap => {
                    setRequests(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                return () => { unsubUsers(); unsubTx(); unsubReq(); };
            }, [user, init]);

            if (!config) return <ConfigScreen onSave={c => { localStorage.setItem('vfs_firebase_config', JSON.stringify(c)); setConfig(c); }} />;
            if (!init) return <div className="loading">กำลังเชื่อมต่อระบบ...</div>;

            const db = firebase.firestore();
            const appId = 'volvo-finance';

            // --- Actions ---
            const restoreAdmin = async () => {
                if(!confirm('สร้าง User: เพิร์ธ (Manager) รหัส 2121?')) return;
                try {
                    await db.collection('app_data').doc(appId).collection('users').add({
                        name: 'เพิร์ธ', role: 'manager', pin: '2121', status: 'active', createdAt: new Date()
                    });
                    alert('สร้างเรียบร้อย! ลองรีเฟรชถ้ายังไม่ขึ้น');
                } catch(e) { alert("Error: " + e.message + "\n(เช็ค Rules ใน Firebase)"); }
            };

            const login = () => {
                if (inputs.pin === selectedProfile.pin) {
                    setUserData(selectedProfile);
                    setSelectedProfile(null);
                    setInputs({});
                } else {
                    alert("รหัส PIN ไม่ถูกต้อง");
                }
            };

            const verifyAdmin = () => {
                if (inputs.adminPin === '2121') { // Simple Manager PIN Check for Quick Access
                    setModals({...modals, adminAuth: false, manage: true});
                    setInputs({});
                } else {
                    alert("รหัสผู้จัดการไม่ถูกต้อง (Default: 2121)");
                }
            }

            const register = async () => {
                if (!inputs.newName || !inputs.newPin) return alert("กรอกข้อมูลให้ครบ");
                await db.collection('app_data').doc(appId).collection('users').add({
                    name: inputs.newName, role: inputs.newRole || 'staff', pin: inputs.newPin, status: 'pending', createdAt: new Date()
                });
                setModals({...modals, register: false});
                setInputs({});
                alert("ส่งคำขอแล้ว รอผู้จัดการอนุมัติ");
            };

            const submitRequest = async () => {
                await db.collection('app_data').doc(appId).collection('requests').add({
                    amount: parseFloat(inputs.amount), description: inputs.desc, requester: userData.name, 
                    requesterId: userData.id, status: 'pending', createdAt: new Date(), type: 'expense'
                });
                setModals({...modals, request: false}); setInputs({});
            };

            const submitDeposit = async () => {
                await db.collection('app_data').doc(appId).collection('transactions').add({
                    amount: parseFloat(inputs.amount), description: inputs.desc, category: 'income',
                    performer: userData.name, type: 'income', createdAt: new Date()
                });
                setModals({...modals, deposit: false}); setInputs({});
            };

            const processRequest = async (req, status) => {
                if (status === 'approved') {
                    await db.collection('app_data').doc(appId).collection('transactions').add({
                        amount: parseFloat(req.amount), description: req.description,
                        performer: req.requester, approver: userData.name, type: 'expense', createdAt: new Date()
                    });
                }
                await db.collection('app_data').doc(appId).collection('requests').doc(req.id).update({status});
            };

            const deleteUser = async (id) => {
                if(confirm("ยืนยันลบผู้ใช้นี้?")) await db.collection('app_data').doc(appId).collection('users').doc(id).delete();
            };

            const updateUserStatus = async (id, status) => {
                await db.collection('app_data').doc(appId).collection('users').doc(id).update({status});
            };

            const balance = transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            const pendingUsers = profiles.filter(p => p.status === 'pending');
            const pendingRequests = requests.filter(r => r.status === 'pending');
            const formatMoney = (n) => new Intl.NumberFormat('th-TH', {style:'currency', currency:'THB'}).format(n);

            // --- Views ---
            if (!userData) {
                const activeUsers = profiles.filter(p => p.status === 'active');
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-50">
                        <div className="mb-8 text-center">
                            <div className="bg-blue-600 text-white w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg"><Icon name="building" size={32}/></div>
                            <h1 className="text-2xl font-bold text-slate-800">Volvo Finance</h1>
                        </div>

                        {activeUsers.length > 0 ? (
                            <div className="grid grid-cols-2 gap-4 w-full max-w-sm mb-6">
                                {activeUsers.map(p => (
                                    <button key={p.id} onClick={() => setSelectedProfile(p)} className="bg-white p-4 rounded-xl border hover:border-blue-500 shadow-sm flex flex-col items-center relative">
                                        <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center font-bold text-slate-600 mb-2">{p.name[0]}</div>
                                        <div className="font-bold">{p.name}</div>
                                        <div className="text-xs text-slate-400 uppercase">{p.role}</div>
                                    </button>
                                ))}
                                <button onClick={() => setModals({...modals, register: true})} className="border-2 border-dashed border-slate-300 p-4 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:bg-slate-100">
                                    <Icon name="plus" size={24} className="mb-2"/> สมัครใหม่
                                </button>
                            </div>
                        ) : (
                            <div className="text-center mb-6">
                                <p className="text-slate-500 mb-4">ยังไม่มีผู้ใช้งานในระบบ</p>
                                <button onClick={restoreAdmin} className="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg font-bold flex items-center gap-2 mx-auto">
                                    <Icon name="user" /> สร้างผู้จัดการ (เพิร์ธ)
                                </button>
                            </div>
                        )}

                        {/* Admin Tools Button */}
                        <div className="flex gap-4 mt-4">
                            <button onClick={() => setModals({...modals, adminAuth: true})} className="text-xs text-slate-400 hover:text-blue-600 flex items-center gap-1 bg-white px-3 py-1 rounded-full border border-slate-200">
                                <Icon name="settings" size={12}/> จัดการผู้ใช้ (Admin)
                            </button>
                            <button onClick={restoreAdmin} className="text-xs text-slate-400 hover:text-blue-600 flex items-center gap-1 bg-white px-3 py-1 rounded-full border border-slate-200">
                                <Icon name="refresh" size={12}/> กู้คืนระบบ
                            </button>
                        </div>

                        {/* PIN Modal */}
                        {selectedProfile && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-xs text-center shadow-xl">
                                    <h3 className="font-bold text-lg mb-4">สวัสดีคุณ {selectedProfile.name}</h3>
                                    <input type="password" className="w-full text-center text-3xl border-b-2 py-2 mb-6 outline-none tracking-widest" 
                                        autoFocus placeholder="PIN" value={inputs.pin || ''} onChange={e=>setInputs({...inputs, pin: e.target.value})} />
                                    <div className="flex gap-2">
                                        <button onClick={()=>setSelectedProfile(null)} className="flex-1 py-2 bg-slate-100 rounded">ยกเลิก</button>
                                        <button onClick={login} className="flex-1 py-2 bg-blue-600 text-white rounded font-bold">เข้าสู่ระบบ</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Admin Auth Modal */}
                        {modals.adminAuth && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-xs text-center shadow-xl">
                                    <div className="text-blue-600 mb-2 flex justify-center"><Icon name="lock" size={32}/></div>
                                    <h3 className="font-bold text-lg mb-4">โหมดผู้ดูแล</h3>
                                    <p className="text-xs text-slate-500 mb-4">ใส่รหัสผู้จัดการเพื่อจัดการรายชื่อ</p>
                                    <input type="password" className="w-full text-center text-3xl border-b-2 py-2 mb-6 outline-none tracking-widest" 
                                        autoFocus placeholder="PIN" value={inputs.adminPin || ''} onChange={e=>setInputs({...inputs, adminPin: e.target.value})} />
                                    <div className="flex gap-2">
                                        <button onClick={()=>setModals({...modals, adminAuth: false})} className="flex-1 py-2 bg-slate-100 rounded">ยกเลิก</button>
                                        <button onClick={verifyAdmin} className="flex-1 py-2 bg-slate-800 text-white rounded font-bold">ยืนยัน</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Register Modal */}
                        {modals.register && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl">
                                    <h3 className="font-bold text-lg mb-4">สมัครสมาชิกใหม่</h3>
                                    <input className="w-full border p-3 rounded-lg mb-3" placeholder="ชื่อเล่น" value={inputs.newName || ''} onChange={e=>setInputs({...inputs, newName: e.target.value})} />
                                    <div className="flex gap-2 mb-3">
                                        <button onClick={()=>setInputs({...inputs, newRole: 'staff'})} className={`flex-1 py-2 border rounded ${inputs.newRole!=='manager'?'bg-blue-50 border-blue-500 text-blue-700':''}`}>พนักงาน</button>
                                        <button onClick={()=>setInputs({...inputs, newRole: 'manager'})} className={`flex-1 py-2 border rounded ${inputs.newRole==='manager'?'bg-blue-50 border-blue-500 text-blue-700':''}`}>ผู้จัดการ</button>
                                    </div>
                                    <input className="w-full border p-3 rounded-lg mb-4 text-center tracking-widest" placeholder="ตั้งรหัส PIN 4 หลัก" maxLength="4" value={inputs.newPin || ''} onChange={e=>setInputs({...inputs, newPin: e.target.value})} />
                                    <div className="flex gap-2">
                                        <button onClick={()=>setModals({...modals, register: false})} className="flex-1 py-2 bg-slate-100 rounded">ยกเลิก</button>
                                        <button onClick={register} className="flex-1 py-2 bg-blue-600 text-white rounded font-bold">ยืนยัน</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* User Management Modal (Login Screen Version) */}
                        {modals.manage && (
                            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto shadow-2xl">
                                    <div className="flex justify-between items-center mb-4 sticky top-0 bg-white pb-2 border-b">
                                        <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="settings"/> จัดการรายชื่อ</h3>
                                        <button onClick={() => setModals({...modals, manage: false})}><Icon name="x"/></button>
                                    </div>
                                    <div className="space-y-3">
                                        {profiles.map(p => (
                                            <div key={p.id} className="flex items-center justify-between p-3 border rounded-xl bg-slate-50">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center font-bold text-slate-500 shadow-sm border">{p.name[0]}</div>
                                                    <div>
                                                        <div className="font-bold text-slate-800">{p.name}</div>
                                                        <div className="text-xs text-slate-500 uppercase">{p.role} • {p.status}</div>
                                                    </div>
                                                </div>
                                                {/* Allow deletion if user is manager, or if in Admin Mode (userData is null) */}
                                                <div className="flex gap-1">
                                                    {p.status === 'pending' && (
                                                        <button onClick={() => updateUserStatus(p.id, 'active')} className="p-2 text-emerald-600 hover:bg-emerald-100 rounded-lg transition-colors">
                                                            <Icon name="check" size={18} />
                                                        </button>
                                                    )}
                                                    {(!userData || userData.id !== p.id) && (
                                                        <button onClick={() => deleteUser(p.id)} className="p-2 text-rose-500 hover:bg-rose-100 rounded-lg transition-colors">
                                                            <Icon name="trash" size={18} />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // 2. Main App View
            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    <header className="bg-white px-4 py-3 sticky top-0 shadow-sm flex justify-between items-center z-10">
                        <div className="flex items-center gap-3">
                            <div className="bg-gradient-to-br from-blue-600 to-indigo-700 w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold">V</div>
                            <div>
                                <h1 className="font-bold text-slate-800">Volvo Finance</h1>
                                <div className="text-xs text-slate-500">{userData.name} ({userData.role})</div>
                            </div>
                        </div>
                        <button onClick={()=>{setUserData(null); setView('dashboard');}} className="p-2 bg-slate-100 rounded-full text-slate-500"><Icon name="logout"/></button>
                    </header>

                    <main className="p-4 space-y-4 max-w-md mx-auto">
                        <div className="bg-slate-800 text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                            <div className="relative z-10">
                                <div className="text-slate-400 text-xs font-bold mb-1">BALANCE</div>
                                <div className="text-4xl font-bold">{formatMoney(balance)}</div>
                            </div>
                            <div className="absolute right-0 top-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={()=>setModals({...modals, request: true})} className="bg-white p-4 rounded-2xl shadow-sm border flex items-center gap-3 hover:bg-blue-50 transition">
                                <div className="bg-blue-100 text-blue-600 p-2 rounded-full"><Icon name="minus"/></div>
                                <div className="text-left"><div className="font-bold">เบิกเงิน</div><div className="text-xs text-slate-400">Request</div></div>
                            </button>
                            {userData.role === 'manager' && (
                                <button onClick={()=>setModals({...modals, deposit: true})} className="bg-white p-4 rounded-2xl shadow-sm border flex items-center gap-3 hover:bg-emerald-50 transition">
                                    <div className="bg-emerald-100 text-emerald-600 p-2 rounded-full"><Icon name="plus"/></div>
                                    <div className="text-left"><div className="font-bold">เติมเงิน</div><div className="text-xs text-slate-400">Deposit</div></div>
                                </button>
                            )}
                        </div>

                        {userData.role === 'manager' && (
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={()=>setView('approvals')} className="bg-amber-50 border border-amber-100 p-3 rounded-xl flex items-center justify-between text-amber-800">
                                    <span className="text-sm font-bold">รออนุมัติ ({pendingRequests.length})</span>
                                    {pendingRequests.length > 0 && <span className="bg-amber-500 text-white text-xs px-2 py-0.5 rounded-full">!</span>}
                                </button>
                                <button onClick={()=>setModals({...modals, manage: true})} className="bg-slate-100 border border-slate-200 p-3 rounded-xl flex items-center justify-between text-slate-700">
                                    <span className="text-sm font-bold">พนักงาน ({pendingUsers.length > 0 ? pendingUsers.length + ' ใหม่' : profiles.length})</span>
                                    {pendingUsers.length > 0 && <span className="bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full">New</span>}
                                </button>
                            </div>
                        )}

                        <div className="bg-white rounded-2xl border shadow-sm overflow-hidden">
                            <div className="bg-slate-50 p-3 border-b text-sm font-bold text-slate-500 flex justify-between">
                                <span>รายการล่าสุด</span>
                                <button onClick={()=>setView('dashboard')} className="text-blue-600">รีเฟรช</button>
                            </div>
                            <div className="divide-y max-h-80 overflow-y-auto">
                                {view === 'dashboard' ? (
                                    transactions.length === 0 ? <div className="p-8 text-center text-slate-400">ไม่มีรายการ</div> :
                                    transactions.map(t => (
                                        <div key={t.id} className="p-3 flex justify-between items-center">
                                            <div className="flex items-center gap-3">
                                                <div className={`p-2 rounded-lg ${t.type==='income'?'bg-emerald-100 text-emerald-600':'bg-slate-100 text-slate-500'}`}>
                                                    <Icon name={t.type==='income'?'plus':'minus'} size={16}/>
                                                </div>
                                                <div>
                                                    <div className="font-bold text-sm text-slate-800">{t.description}</div>
                                                    <div className="text-xs text-slate-400">{t.performer} • {new Date(t.createdAt?.seconds*1000).toLocaleDateString('th-TH')}</div>
                                                </div>
                                            </div>
                                            <div className={`font-bold ${t.type==='income'?'text-emerald-600':'text-slate-800'}`}>
                                                {t.type==='income'?'+':'-'}{formatMoney(t.amount)}
                                            </div>
                                        </div>
                                    ))
                                ) : view === 'approvals' ? (
                                    pendingRequests.length === 0 ? <div className="p-8 text-center text-slate-400">ไม่มีรายการรออนุมัติ</div> :
                                    pendingRequests.map(r => (
                                        <div key={r.id} className="p-4 bg-amber-50 border-b border-amber-100 last:border-0">
                                            <div className="flex justify-between mb-2">
                                                <div><div className="font-bold text-lg">{r.description}</div><div className="text-xs text-slate-500">โดย {r.requester}</div></div>
                                                <div className="font-bold text-lg text-slate-800">{formatMoney(r.amount)}</div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={()=>processRequest(r, 'approved')} className="bg-emerald-500 text-white px-4 py-1.5 rounded-lg text-sm flex-1">อนุมัติ</button>
                                                <button onClick={()=>processRequest(r, 'rejected')} className="bg-white border border-slate-300 text-slate-600 px-4 py-1.5 rounded-lg text-sm flex-1">ปฏิเสธ</button>
                                            </div>
                                        </div>
                                    ))
                                ) : null}
                            </div>
                        </div>
                    </main>

                    {modals.request && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm">
                                <h3 className="font-bold text-lg mb-4">ขอเบิกเงิน</h3>
                                <input className="w-full border p-3 rounded-lg mb-3" placeholder="รายการ" autoFocus value={inputs.desc || ''} onChange={e=>setInputs({...inputs, desc: e.target.value})} />
                                <input className="w-full border p-3 rounded-lg mb-4" type="number" placeholder="จำนวนเงิน" value={inputs.amount || ''} onChange={e=>setInputs({...inputs, amount: e.target.value})} />
                                <div className="flex gap-2">
                                    <button onClick={()=>setModals({...modals, request: false})} className="flex-1 py-3 bg-slate-100 rounded-lg">ยกเลิก</button>
                                    <button onClick={submitRequest} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold">ส่งคำขอ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modals.deposit && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm">
                                <h3 className="font-bold text-lg mb-4">เติมเงิน</h3>
                                <input className="w-full border p-3 rounded-lg mb-3" placeholder="รายละเอียด" autoFocus value={inputs.desc || ''} onChange={e=>setInputs({...inputs, desc: e.target.value})} />
                                <input className="w-full border p-3 rounded-lg mb-4" type="number" placeholder="จำนวนเงิน" value={inputs.amount || ''} onChange={e=>setInputs({...inputs, amount: e.target.value})} />
                                <div className="flex gap-2">
                                    <button onClick={()=>setModals({...modals, deposit: false})} className="flex-1 py-3 bg-slate-100 rounded-lg">ยกเลิก</button>
                                    <button onClick={submitDeposit} className="flex-1 py-3 bg-emerald-600 text-white rounded-lg font-bold">ยืนยัน</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modals.manage && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">จัดการพนักงาน</h3>
                                    <button onClick={()=>setModals({...modals, manage: false})}><Icon name="x"/></button>
                                </div>
                                <div className="space-y-3">
                                    {profiles.map(p => (
                                        <div key={p.id} className="flex items-center justify-between p-3 border rounded-xl bg-slate-50">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center font-bold border shadow-sm">{p.name[0]}</div>
                                                <div>
                                                    <div className="font-bold text-slate-800">{p.name} {userData && userData.id === p.id && <span className="text-xs text-blue-600">(ฉัน)</span>}</div>
                                                    <div className="text-xs text-slate-500 uppercase">{p.role} • {p.status}</div>
                                                </div>
                                            </div>
                                            <div className="flex gap-1">
                                                {p.status === 'pending' && <button onClick={()=>updateUserStatus(p.id, 'active')} className="p-2 text-emerald-600 bg-emerald-100 rounded-lg"><Icon name="check"/></button>}
                                                {userData.id !== p.id && <button onClick={()=>deleteUser(p.id)} className="p-2 text-rose-600 hover:bg-rose-100 rounded-lg"><Icon name="trash"/></button>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>