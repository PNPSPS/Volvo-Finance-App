<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volvo Finance Service</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style> 
        body { 
            font-family: 'Prompt', sans-serif; 
            background-image: url('https://images.unsplash.com/photo-1625047509168-a7026f36de04?q=80&w=2564&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
        }
        #root {
            background-color: rgba(255, 255, 255, 0.75);
            min-height: 100vh;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; color: #64748b; font-size: 1.2rem; }
    </style>
</head>
<body>
    <div id="error-display"></div>
    <div id="root"></div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ -->
    <button onclick="localStorage.removeItem('vfs_firebase_config'); window.location.reload();" style="position: fixed; bottom: 10px; right: 10px; opacity: 0.5; font-size: 10px; background: #eee; border: none; padding: 5px; cursor: pointer; z-index: 9999;">
        Reset Config
    </button>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-display').innerHTML = `
                <div style="padding: 20px; background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; margin: 20px; border-radius: 8px; font-family: sans-serif;">
                    <h3>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (System Error)</h3>
                    <p><b>Message:</b> ${message}</p>
                    <button onclick="localStorage.clear(); window.location.reload();" style="margin-top:10px; padding:5px 10px; cursor:pointer;">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</button>
                </div>
            `;
            return true;
        };
    </script>

    <script type="text/babel">
        // ==========================================
        // üü¢ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡∏±‡∏á Config (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Download)
        // ==========================================
        const FIREBASE_CONFIG = null; // CONFIG_PLACEHOLDER
        
        if (!window.React || !window.ReactDOM || !window.firebase) {
            throw new Error("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠... ‡∏´‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
        }

        const { useState, useEffect, useMemo } = React;

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                settings: <path d="M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
                user: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
                lock: <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></g>,
                building: <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18 M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2 M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2 M10 6h4 M10 10h4 M10 14h4 M10 18h4" />,
                logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />,
                plus: <g><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></g>,
                minus: <line x1="5" y1="12" x2="19" y2="12" />,
                wallet: <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4h-4z" />,
                users: <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M16 3.13a4 4 0 0 1 0 7.75" />,
                trash: <g><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></g>,
                refresh: <g><polyline points="23 4 23 10 17 10" /><polyline points="1 20 1 14 7 14" /><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></g>,
                x: <g><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></g>,
                check: <polyline points="20 6 9 17 4 12" />,
                pieChart: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />,
                tag: <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82zM7 7h.01" />,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- Config Screen with Export Feature ---
        const ConfigScreen = ({ onSave }) => {
            const [input, setInput] = useState('');
            const [err, setErr] = useState('');

            const parseConfig = (text) => {
                let clean = text.trim().replace(/^(const|var|let)\s+firebaseConfig\s*=\s*/, '').replace(/;$/, '');
                let json;
                try { json = JSON.parse(clean); } 
                catch { json = new Function('return ' + clean)(); }
                if (!json || !json.apiKey) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡πà‡∏≤ apiKey");
                return json;
            };

            const saveLocal = () => {
                try {
                    const json = parseConfig(input);
                    onSave(json);
                } catch (e) {
                    setErr('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà');
                }
            };

            const downloadShareableFile = () => {
                try {
                    const json = parseConfig(input);
                    // Get current HTML source
                    let source = document.documentElement.outerHTML;
                    // Inject the config
                    const configString = JSON.stringify(json, null, 2);
                    const placeholder = "const FIREBASE_CONFIG = null; // CONFIG_PLACEHOLDER";
                    
                    if (source.includes(placeholder)) {
                        source = source.replace(placeholder, `const FIREBASE_CONFIG = ${configString};`);
                        
                        // Create download
                        const blob = new Blob([source], { type: 'text/html' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'VolvoFinance_App.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        alert("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå 'VolvoFinance_App.html' ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏µ‡∏Å)");
                        
                        // Also save locally for current user
                        onSave(json);
                    } else {
                        setErr('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏ß‡∏≤‡∏á Config ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà)');
                    }
                } catch (e) {
                    setErr('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå: ' + e.message);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4">
                    <div className="bg-white/90 backdrop-blur-xl p-8 rounded-2xl shadow-xl w-full max-w-md border border-white">
                        <h2 className="text-xl font-bold mb-4 text-center text-slate-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h2>
                        <textarea className="w-full h-40 p-3 border rounded-xl mb-4 text-xs font-mono bg-white/50" 
                            placeholder='‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î firebaseConfig ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...' 
                            value={input} onChange={e=>setInput(e.target.value)}></textarea>
                        {err && <div className="text-red-500 text-xs mb-2 text-center">{err}</div>}
                        
                        <div className="flex flex-col gap-3">
                            <button onClick={downloadShareableFile} className="w-full bg-emerald-600 text-white py-3 rounded-xl hover:bg-emerald-700 shadow-lg font-bold flex items-center justify-center gap-2">
                                <Icon name="download" /> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
                            </button>
                            <button onClick={saveLocal} className="w-full bg-slate-200 text-slate-700 py-3 rounded-xl hover:bg-slate-300 font-bold">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ
                            </button>
                        </div>
                        <p className="text-xs text-center text-slate-500 mt-4 opacity-80">
                            * ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ù‡∏±‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        </p>
                    </div>
                </div>
            );
        };

        const INCOME_CATEGORIES = [
            { id: 'scrap', label: '‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤/‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•', color: 'bg-orange-100 text-orange-700', icon: '‚ôªÔ∏è' },
            { id: 'contribution', label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏ó‡∏ö/‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ', color: 'bg-indigo-100 text-indigo-700', icon: 'ü§ù' },
            { id: 'fine', label: '‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö', color: 'bg-rose-100 text-rose-700', icon: '‚ö†Ô∏è' },
            { id: 'activity', label: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©', color: 'bg-purple-100 text-purple-700', icon: 'üéâ' },
            { id: 'other', label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', color: 'bg-slate-100 text-slate-700', icon: 'üì¶' }
        ];

        // --- Main App ---
        const App = () => {
            const [config, setConfig] = useState(() => {
                try {
                    const saved = localStorage.getItem('vfs_firebase_config');
                    return FIREBASE_CONFIG || (saved ? JSON.parse(saved) : null);
                } catch { return null; }
            });

            const [init, setInit] = useState(false);
            const [user, setUser] = useState(null);
            
            // UI State
            const [userData, setUserData] = useState(null);
            const [view, setView] = useState('dashboard'); 
            const [modals, setModals] = useState({ register: false, request: false, deposit: false, manage: false, adminAuth: false });
            const [profiles, setProfiles] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [requests, setRequests] = useState([]);
            const [inputs, setInputs] = useState({});
            const [selectedProfile, setSelectedProfile] = useState(null);
            const [depositCategory, setDepositCategory] = useState('scrap');

            // Income Breakdown Calculation
            const incomeBreakdown = useMemo(() => {
                const summary = {};
                INCOME_CATEGORIES.forEach(cat => summary[cat.id] = 0);
                transactions.forEach(t => {
                    if (t.type === 'income') {
                        const catId = t.category || 'other';
                        summary[catId] = (summary[catId] || 0) + t.amount;
                    }
                });
                return INCOME_CATEGORIES.map(cat => ({
                    ...cat,
                    total: summary[cat.id] || 0,
                    percent: (summary[cat.id] || 0) > 0 ? ((summary[cat.id] || 0) / transactions.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0)) * 100 : 0
                })).sort((a,b) => b.total - a.total);
            }, [transactions]);

            // Balance Calculation
            const balance = useMemo(() => {
                return transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            }, [transactions]);

            // Initialize Firebase
            useEffect(() => {
                if (!config) return;
                try {
                    if (!firebase.apps.length) firebase.initializeApp(config);
                    
                    const auth = firebase.auth();
                    auth.onAuthStateChanged(u => {
                        if (!u) auth.signInAnonymously().catch(e => console.error("Auth Error", e));
                        setUser(u);
                    });
                    setInit(true);
                } catch (e) {
                    alert("Firebase Init Failed: " + e.message);
                    localStorage.removeItem('vfs_firebase_config');
                }
            }, [config]);

            // Data Listening
            useEffect(() => {
                if (!user || !init) return;
                const db = firebase.firestore();
                const appId = 'volvo-finance';

                const unsubUsers = db.collection('app_data').doc(appId).collection('users').onSnapshot(snap => {
                    setProfiles(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                const unsubTx = db.collection('app_data').doc(appId).collection('transactions')
                    .orderBy('createdAt', 'desc').limit(100).onSnapshot(snap => {
                    setTransactions(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                const unsubReq = db.collection('app_data').doc(appId).collection('requests')
                    .orderBy('createdAt', 'desc').limit(50).onSnapshot(snap => {
                    setRequests(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                return () => { unsubUsers(); unsubTx(); unsubReq(); };
            }, [user, init]);

            if (!config) return <ConfigScreen onSave={c => { localStorage.setItem('vfs_firebase_config', JSON.stringify(c)); setConfig(c); }} />;
            if (!init) return <div className="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</div>;

            const db = firebase.firestore();
            const appId = 'volvo-finance';

            // Actions
            const restoreAdmin = async () => {
                if(!confirm('‡∏™‡∏£‡πâ‡∏≤‡∏á User: ‡πÄ‡∏û‡∏¥‡∏£‡πå‡∏ò (Manager) ‡∏£‡∏´‡∏±‡∏™ 2121?')) return;
                try {
                    await db.collection('app_data').doc(appId).collection('users').add({
                        name: '‡πÄ‡∏û‡∏¥‡∏£‡πå‡∏ò', role: 'manager', pin: '2121', status: 'active', createdAt: new Date()
                    });
                    alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                } catch(e) { alert("Error: " + e.message); }
            };

            const login = () => {
                if (inputs.pin === selectedProfile.pin) {
                    setUserData(selectedProfile);
                    setSelectedProfile(null);
                    setInputs({});
                } else {
                    alert("‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            };

            const verifyAdmin = () => {
                if (inputs.adminPin === '2121') {
                    setModals({...modals, adminAuth: false, manage: true});
                    setInputs({});
                } else {
                    alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Default: 2121)");
                }
            }

            const register = async () => {
                if (!inputs.newName || !inputs.newPin) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
                await db.collection('app_data').doc(appId).collection('users').add({
                    name: inputs.newName, role: inputs.newRole || 'staff', pin: inputs.newPin, status: 'pending', createdAt: new Date()
                });
                setModals({...modals, register: false});
                setInputs({});
                alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");
            };

            const submitRequest = async () => {
                await db.collection('app_data').doc(appId).collection('requests').add({
                    amount: parseFloat(inputs.amount), description: inputs.desc, requester: userData.name, 
                    requesterId: userData.id, status: 'pending', createdAt: new Date(), type: 'expense'
                });
                setModals({...modals, request: false}); setInputs({});
            };

            const submitDeposit = async () => {
                const category = INCOME_CATEGORIES.find(c => c.id === depositCategory) || INCOME_CATEGORIES[4];
                await db.collection('app_data').doc(appId).collection('transactions').add({
                    amount: parseFloat(inputs.amount), description: inputs.desc, category: depositCategory,
                    categoryLabel: category.label, performer: userData.name, type: 'income', createdAt: new Date()
                });
                setModals({...modals, deposit: false}); setInputs({});
            };

            const processRequest = async (req, status) => {
                if (status === 'approved') {
                    await db.collection('app_data').doc(appId).collection('transactions').add({
                        amount: parseFloat(req.amount), description: req.description,
                        performer: req.requester, approver: userData.name, type: 'expense', createdAt: new Date()
                    });
                }
                await db.collection('app_data').doc(appId).collection('requests').doc(req.id).update({status});
            };

            const deleteUser = async (id) => {
                if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?")) await db.collection('app_data').doc(appId).collection('users').doc(id).delete();
            };

            const updateUserStatus = async (id, status) => {
                await db.collection('app_data').doc(appId).collection('users').doc(id).update({status});
            };

            const pendingUsers = profiles.filter(p => p.status === 'pending');
            const pendingRequests = requests.filter(r => r.status === 'pending');
            const formatMoney = (n) => new Intl.NumberFormat('th-TH', {style:'currency', currency:'THB'}).format(n);

            // --- Views ---
            if (!userData) {
                const activeUsers = profiles.filter(p => p.status === 'active');
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="w-full max-w-lg mb-8 relative z-10 animate-in">
                            <div className="text-center mb-8">
                                <div className="w-24 h-24 bg-gradient-to-tr from-blue-700 to-slate-800 rounded-3xl flex items-center justify-center mx-auto mb-5 shadow-2xl shadow-blue-900/40 rotate-3 border-4 border-white/20">
                                    <Icon name="building" size={48} className="text-white"/>
                                </div>
                                <h1 className="text-3xl font-bold text-slate-800 drop-shadow-sm tracking-tight">Volvo Finance</h1>
                                <p className="text-slate-600 font-medium mt-1">Service Center Management</p>
                            </div>

                            {activeUsers.length > 0 ? (
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    {activeUsers.map(p => (
                                        <button key={p.id} onClick={() => setSelectedProfile(p)} className="glass-card p-5 rounded-2xl flex flex-col items-center group transition-all hover:scale-[1.02] hover:bg-white/90">
                                            <div className="w-14 h-14 bg-gradient-to-br from-slate-100 to-slate-200 rounded-full flex items-center justify-center font-bold text-lg text-slate-600 mb-3 shadow-inner group-hover:from-blue-100 group-hover:to-blue-200 group-hover:text-blue-700 transition-colors">
                                                {p.name[0]}
                                            </div>
                                            <div className="font-bold text-slate-800 text-lg">{p.name}</div>
                                            <div className="text-xs text-slate-500 uppercase font-semibold tracking-wide mt-1">{p.role}</div>
                                        </button>
                                    ))}
                                    <button onClick={() => setModals({...modals, register: true})} className="border-2 border-dashed border-slate-300/60 p-4 rounded-2xl flex flex-col items-center justify-center text-slate-500 hover:bg-white/40 hover:text-blue-600 hover:border-blue-400 transition-all">
                                        <Icon name="plus" size={32} className="mb-2 opacity-50"/> <span className="font-medium">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</span>
                                    </button>
                                </div>
                            ) : (
                                <div className="text-center mb-6 p-6 glass-card rounded-2xl">
                                    <p className="text-slate-500 mb-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                                    <button onClick={restoreAdmin} className="bg-blue-600 text-white px-6 py-3 rounded-xl shadow-lg font-bold flex items-center gap-2 mx-auto hover:bg-blue-700 transition-all">
                                        <Icon name="user" /> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡πÄ‡∏û‡∏¥‡∏£‡πå‡∏ò)
                                    </button>
                                </div>
                            )}

                            {/* Admin Tools */}
                            <div className="flex justify-center gap-3 mt-6">
                                <button onClick={() => setModals({...modals, adminAuth: true})} className="text-xs text-slate-500 hover:text-blue-700 flex items-center gap-1.5 bg-white/70 px-4 py-2 rounded-full shadow-sm border border-white/50 backdrop-blur-sm transition-all hover:bg-white">
                                    <Icon name="settings" size={14}/> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Admin)
                                </button>
                                <button onClick={restoreAdmin} className="text-xs text-slate-500 hover:text-blue-700 flex items-center gap-1.5 bg-white/70 px-4 py-2 rounded-full shadow-sm border border-white/50 backdrop-blur-sm transition-all hover:bg-white">
                                    <Icon name="refresh" size={14}/> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                                </button>
                            </div>
                        </div>

                        {/* PIN Modal */}
                        {selectedProfile && (
                            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in">
                                <div className="bg-white/95 backdrop-blur-xl p-8 rounded-3xl w-full max-w-xs text-center shadow-2xl border border-white/50">
                                    <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 font-bold text-2xl shadow-inner">
                                        {selectedProfile.name[0]}
                                    </div>
                                    <h3 className="font-bold text-xl mb-1 text-slate-800">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h3>
                                    <p className="text-slate-500 mb-8 font-medium">‡∏Ñ‡∏∏‡∏ì {selectedProfile.name}</p>
                                    <input type="password" className="w-full text-center text-4xl tracking-[0.5em] border-b-2 border-slate-200 focus:border-blue-500 outline-none py-2 mb-8 bg-transparent font-mono text-slate-800 transition-all" 
                                        autoFocus placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={inputs.pin || ''} onChange={e=>setInputs({...inputs, pin: e.target.value})} />
                                    <div className="flex gap-3">
                                        <button onClick={()=>setSelectedProfile(null)} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                        <button onClick={login} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-transform active:scale-95">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Admin Auth Modal */}
                        {modals.adminAuth && (
                            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in">
                                <div className="bg-white/95 backdrop-blur-xl p-8 rounded-3xl w-full max-w-xs text-center shadow-2xl border border-white/50">
                                    <div className="text-blue-600 mb-4 flex justify-center"><Icon name="lock" size={40}/></div>
                                    <h3 className="font-bold text-xl mb-2 text-slate-800">‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h3>
                                    <p className="text-xs text-slate-500 mb-6">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</p>
                                    <input type="password" className="w-full text-center text-4xl tracking-[0.5em] border-b-2 border-slate-200 focus:border-blue-500 outline-none py-2 mb-8 bg-transparent font-mono text-slate-800" 
                                        autoFocus placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={inputs.adminPin || ''} onChange={e=>setInputs({...inputs, adminPin: e.target.value})} />
                                    <div className="flex gap-3">
                                        <button onClick={()=>setModals({...modals, adminAuth: false})} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                        <button onClick={verifyAdmin} className="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Register Modal */}
                        {modals.register && (
                            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in">
                                <div className="bg-white/95 backdrop-blur-xl p-6 rounded-3xl w-full max-w-sm shadow-2xl border border-white/50">
                                    <h3 className="font-bold text-xl mb-6 text-slate-800 flex items-center gap-2">
                                        <div className="bg-blue-100 p-2 rounded-lg text-blue-600"><Icon name="userPlus" size={24}/></div> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà
                                    </h3>
                                    <div className="space-y-4">
                                        <input className="w-full p-4 border border-slate-200 rounded-xl bg-slate-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (Nickname)" value={inputs.newName || ''} onChange={e=>setInputs({...inputs, newName: e.target.value})} />
                                        <div className="flex gap-2 p-1 bg-slate-100 rounded-xl">
                                            <button onClick={()=>setInputs({...inputs, newRole: 'staff'})} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${inputs.newRole!=='manager'?'bg-white text-blue-700 shadow-sm':'text-slate-500 hover:text-slate-700'}`}>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                                            <button onClick={()=>setInputs({...inputs, newRole: 'manager'})} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${inputs.newRole==='manager'?'bg-white text-blue-700 shadow-sm':'text-slate-500 hover:text-slate-700'}`}>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
                                        </div>
                                        <input className="w-full p-4 border border-slate-200 rounded-xl bg-slate-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-center tracking-widest font-mono text-lg transition-all" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™ PIN 4 ‡∏´‡∏•‡∏±‡∏Å" maxLength="4" value={inputs.newPin || ''} onChange={e=>setInputs({...inputs, newPin: e.target.value})} />
                                        <div className="flex gap-3 pt-2">
                                            <button onClick={()=>setModals({...modals, register: false})} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                            <button onClick={register} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* User Management Modal (Login Screen Version) */}
                        {modals.manage && (
                            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 animate-in">
                                <div className="bg-white p-6 rounded-3xl w-full max-w-sm max-h-[80vh] overflow-y-auto shadow-2xl">
                                    <div className="flex justify-between items-center mb-6 sticky top-0 bg-white pb-4 border-b border-slate-100">
                                        <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2"><div className="bg-slate-100 p-2 rounded-lg"><Icon name="settings" size={20}/></div> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h3>
                                        <button onClick={() => setModals({...modals, manage: false})} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="x"/></button>
                                    </div>
                                    <div className="space-y-3">
                                        {profiles.map(p => (
                                            <div key={p.id} className="flex items-center justify-between p-3 border border-slate-200 rounded-2xl bg-slate-50/50">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center font-bold text-slate-500 shadow-sm border border-slate-100">{p.name[0]}</div>
                                                    <div>
                                                        <div className="font-bold text-slate-800">{p.name}</div>
                                                        <div className="text-xs text-slate-500 uppercase font-semibold bg-white px-2 py-0.5 rounded border border-slate-200 inline-block mt-0.5">{p.role} ‚Ä¢ {p.status}</div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    {p.status === 'pending' && (
                                                        <button onClick={() => updateUserStatus(p.id, 'active')} className="p-2 text-white bg-emerald-500 hover:bg-emerald-600 rounded-xl shadow-sm transition-colors">
                                                            <Icon name="check" size={18} />
                                                        </button>
                                                    )}
                                                    {(!userData || userData.id !== p.id) && (
                                                        <button onClick={() => deleteUser(p.id)} className="p-2 text-rose-500 bg-white border border-rose-200 hover:bg-rose-50 rounded-xl transition-colors">
                                                            <Icon name="trash" size={18} />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // 2. Main App View
            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white/80 backdrop-blur-md px-4 py-3 sticky top-0 shadow-sm flex justify-between items-center z-10 border-b border-white/50">
                        <div className="flex items-center gap-3">
                            <div className="bg-gradient-to-br from-blue-600 to-indigo-700 w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-md">V</div>
                            <div>
                                <h1 className="font-bold text-slate-800">Volvo Finance</h1>
                                <div className="text-xs text-slate-500 font-medium">{userData.name} ({userData.role})</div>
                            </div>
                        </div>
                        <button onClick={()=>{setUserData(null); setView('dashboard');}} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 transition-colors"><Icon name="logout"/></button>
                    </header>

                    <main className="p-4 space-y-6 max-w-md mx-auto">
                        {/* Balance Card */}
                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 rounded-[2rem] shadow-2xl relative overflow-hidden group">
                            <div className="relative z-10">
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex items-center gap-2 text-slate-400 text-xs font-bold tracking-wider bg-white/10 px-3 py-1 rounded-full backdrop-blur-md"><Icon name="creditCard" size={12}/> SERVICE FUND</div>
                                    <Icon name="building" className="text-slate-600" size={24}/>
                                </div>
                                <div className="text-5xl font-bold tracking-tight">{formatMoney(balance).split('.')[0]}<span className="text-2xl text-slate-400 font-normal">.{formatMoney(balance).split('.')[1]}</span></div>
                                <div className="text-slate-400 text-xs mt-2 font-medium">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                            </div>
                            <div className="absolute right-0 top-0 w-40 h-40 bg-blue-500/20 rounded-full blur-3xl -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                            <div className="absolute left-0 bottom-0 w-32 h-32 bg-indigo-500/20 rounded-full blur-3xl -ml-5 -mb-5 transition-transform group-hover:scale-110"></div>
                        </div>

                        {/* Menu Grid */}
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={()=>setModals({...modals, request: true})} className="glass-card p-5 rounded-2xl flex items-center gap-4 hover:shadow-md hover:scale-[1.02] transition-all group border-0">
                                <div className="bg-blue-50 text-blue-600 w-12 h-12 rounded-2xl flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors shadow-sm"><Icon name="minusCircle" size={24}/></div>
                                <div className="text-left"><div className="font-bold text-slate-800">‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</div><div className="text-xs text-slate-500 font-medium">Request</div></div>
                            </button>
                            {userData.role === 'manager' && (
                                <button onClick={()=>setModals({...modals, deposit: true})} className="glass-card p-5 rounded-2xl flex items-center gap-4 hover:shadow-md hover:scale-[1.02] transition-all group border-0">
                                    <div className="bg-emerald-50 text-emerald-600 w-12 h-12 rounded-2xl flex items-center justify-center group-hover:bg-emerald-600 group-hover:text-white transition-colors shadow-sm"><Icon name="plusCircle" size={24}/></div>
                                    <div className="text-left"><div className="font-bold text-slate-800">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div><div className="text-xs text-slate-500 font-medium">Deposit</div></div>
                                </button>
                            )}
                        </div>

                        {userData.role === 'manager' && (
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={()=>setView('approvals')} className="bg-amber-50/80 backdrop-blur-sm border border-amber-100 p-4 rounded-2xl flex items-center justify-between text-amber-800 shadow-sm hover:bg-amber-100 transition-colors">
                                    <span className="text-sm font-bold">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ({pendingRequests.length})</span>
                                    {pendingRequests.length > 0 && <span className="bg-amber-500 text-white text-xs px-2 py-0.5 rounded-full font-bold">!</span>}
                                </button>
                                <button onClick={()=>setModals({...modals, manage: true})} className="glass-card border border-white/50 p-4 rounded-2xl flex items-center justify-between text-slate-700 hover:bg-white transition-colors">
                                    <span className="text-sm font-bold">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ({pendingUsers.length > 0 ? pendingUsers.length + ' ‡πÉ‡∏´‡∏°‡πà' : profiles.length})</span>
                                    {pendingUsers.length > 0 && <span className="bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full font-bold">New</span>}
                                </button>
                            </div>
                        )}

                        {/* Income Summary Breakdown */}
                        {view === 'dashboard' && incomeBreakdown.some(i => i.total > 0) && (
                            <div className="glass-card rounded-[2rem] p-5 shadow-sm border border-white/50">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-4"><Icon name="pieChart" size={18} className="text-indigo-500"/> ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô</h3>
                                <div className="space-y-3">
                                    {incomeBreakdown.filter(i => i.total > 0).map(cat => (
                                        <div key={cat.id} className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-lg ${cat.color.replace('text-', 'bg-').replace('100', '50')}`}>
                                                    {cat.icon}
                                                </div>
                                                <div>
                                                    <div className="text-sm font-bold text-slate-700">{cat.label}</div>
                                                    <div className="w-24 h-1.5 bg-slate-200 rounded-full mt-1 overflow-hidden">
                                                        <div className="h-full bg-indigo-500 rounded-full" style={{width: `${cat.percent}%`}}></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-slate-800 text-sm">{formatMoney(cat.total)}</div>
                                                <div className="text-[10px] text-slate-400 font-bold">{cat.percent.toFixed(0)}%</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Recent Transactions */}
                        <div className="glass-card rounded-[2rem] border border-white/50 shadow-sm overflow-hidden">
                            <div className="bg-white/50 p-4 border-b border-slate-100 flex justify-between items-center backdrop-blur-sm">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="history" size={18} className="text-blue-500"/> {view === 'dashboard' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : view === 'approvals' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô'}</h3>
                                {view !== 'dashboard' && <button onClick={()=>setView('dashboard')} className="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-lg">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>}
                            </div>
                            <div className="divide-y divide-slate-100/50 max-h-96 overflow-y-auto">
                                {view === 'dashboard' ? (
                                    transactions.length === 0 ? <div className="p-8 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div> :
                                    transactions.map(t => (
                                        <div key={t.id} className="p-4 hover:bg-white/40 transition-colors flex justify-between items-center">
                                            <div className="flex items-center gap-4">
                                                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shadow-sm ${t.type==='income'?'bg-emerald-50 text-emerald-600':'bg-slate-50 text-slate-500'}`}>
                                                    <Icon name={t.type==='income'?'trendingUp':'trendingDown'} size={20}/>
                                                </div>
                                                <div>
                                                    <div className="font-bold text-sm text-slate-800">{t.description}</div>
                                                    <div className="text-xs text-slate-400 font-medium mt-0.5">{t.performer} ‚Ä¢ {new Date(t.createdAt?.seconds*1000).toLocaleDateString('th-TH')}</div>
                                                </div>
                                            </div>
                                            <div className={`font-bold text-base ${t.type==='income'?'text-emerald-600':'text-slate-800'}`}>
                                                {t.type==='income'?'+':'-'}{formatMoney(t.amount)}
                                            </div>
                                        </div>
                                    ))
                                ) : view === 'approvals' ? (
                                    pendingRequests.length === 0 ? <div className="p-8 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div> :
                                    pendingRequests.map(r => (
                                        <div key={r.id} className="p-5 bg-amber-50/50 border-b border-amber-100/50 last:border-0">
                                            <div className="flex justify-between mb-3">
                                                <div>
                                                    <div className="font-bold text-lg text-slate-800">{r.description}</div>
                                                    <div className="text-xs text-slate-500 font-medium bg-white px-2 py-1 rounded-lg w-fit mt-1 shadow-sm">‡πÇ‡∏î‡∏¢ {r.requester}</div>
                                                </div>
                                                <div className="font-bold text-xl text-slate-800">{formatMoney(r.amount)}</div>
                                            </div>
                                            <div className="flex gap-3">
                                                <button onClick={()=>processRequest(r, 'approved')} className="bg-emerald-500 text-white px-4 py-2.5 rounded-xl text-sm font-bold flex-1 shadow-md shadow-emerald-500/20 hover:bg-emerald-600 transition-all">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                                <button onClick={()=>processRequest(r, 'rejected')} className="bg-white border border-slate-200 text-slate-600 px-4 py-2.5 rounded-xl text-sm font-bold flex-1 hover:bg-slate-50 transition-all">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                            </div>
                                        </div>
                                    ))
                                ) : null}
                            </div>
                        </div>
                    </main>

                    {modals.request && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in">
                            <div className="bg-white p-6 rounded-3xl w-full max-w-sm shadow-2xl">
                                <h3 className="font-bold text-xl mb-6 text-slate-800 flex items-center gap-2"><div className="bg-blue-100 p-2 rounded-xl text-blue-600"><Icon name="minusCircle" size={24}/></div> ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</h3>
                                <input className="w-full border p-4 rounded-2xl mb-3 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢" autoFocus value={inputs.desc || ''} onChange={e=>setInputs({...inputs, desc: e.target.value})} />
                                <input className="w-full border p-4 rounded-2xl mb-6 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all text-lg font-medium" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" value={inputs.amount || ''} onChange={e=>setInputs({...inputs, amount: e.target.value})} />
                                <div className="flex gap-3">
                                    <button onClick={()=>setModals({...modals, request: false})} className="flex-1 py-3 bg-slate-100 rounded-xl text-slate-600 font-bold hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button onClick={submitRequest} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modals.deposit && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in">
                            <div className="bg-white p-6 rounded-3xl w-full max-w-sm shadow-2xl">
                                <h3 className="font-bold text-xl mb-6 text-slate-800 flex items-center gap-2"><div className="bg-emerald-100 p-2 rounded-xl text-emerald-600"><Icon name="plusCircle" size={24}/></div> ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h3>
                                <select className="w-full border p-4 rounded-2xl mb-3 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition-all appearance-none" value={depositCategory} onChange={e=>setDepositCategory(e.target.value)}>
                                    {INCOME_CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.icon} {c.label}</option>)}
                                </select>
                                <input className="w-full border p-4 rounded-2xl mb-3 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition-all" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" autoFocus value={inputs.desc || ''} onChange={e=>setInputs({...inputs, desc: e.target.value})} />
                                <input className="w-full border p-4 rounded-2xl mb-6 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition-all text-lg font-medium" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" value={inputs.amount || ''} onChange={e=>setInputs({...inputs, amount: e.target.value})} />
                                <div className="flex gap-3">
                                    <button onClick={()=>setModals({...modals, deposit: false})} className="flex-1 py-3 bg-slate-100 rounded-xl text-slate-600 font-bold hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button onClick={submitDeposit} className="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/30 hover:bg-emerald-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modals.manage && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in">
                            <div className="bg-white p-6 rounded-3xl w-full max-w-sm max-h-[80vh] overflow-y-auto shadow-2xl">
                                <div className="flex justify-between items-center mb-6 sticky top-0 bg-white pb-4 border-b border-slate-100">
                                    <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2"><div className="bg-slate-100 p-2 rounded-xl"><Icon name="settings"/></div> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                                    <button onClick={()=>setModals({...modals, manage: false})} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="x"/></button>
                                </div>
                                <div className="space-y-3">
                                    {profiles.map(p => (
                                        <div key={p.id} className="flex items-center justify-between p-4 border border-slate-200 rounded-2xl bg-slate-50/50">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center font-bold text-slate-500 shadow-sm border border-slate-100">{p.name[0]}</div>
                                                <div>
                                                    <div className="font-bold text-slate-800">{p.name} {userData && userData.id === p.id && <span className="text-xs text-blue-600">(‡∏â‡∏±‡∏ô)</span>}</div>
                                                    <div className="text-xs text-slate-500 uppercase font-semibold bg-white px-2 py-0.5 rounded border border-slate-200 inline-block mt-0.5">{p.role} ‚Ä¢ {p.status}</div>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                {p.status === 'pending' && <button onClick={()=>updateUserStatus(p.id, 'active')} className="p-2 text-white bg-emerald-500 rounded-xl hover:bg-emerald-600 shadow-sm transition-colors"><Icon name="check"/></button>}
                                                {userData.id !== p.id && <button onClick={()=>deleteUser(p.id)} className="p-2 text-rose-500 bg-white border border-rose-200 hover:bg-rose-50 rounded-xl transition-colors"><Icon name="trash"/></button>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>