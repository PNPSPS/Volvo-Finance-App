<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volvo Finance Service (Debug Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.309.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style> 
        body { 
            font-family: 'Prompt', sans-serif; 
            /* ภาพพื้นหลัง Workshop ที่ดูสะอาดและเป็นระเบียบ */
            background-image: url('https://images.unsplash.com/photo-1619642751034-765dfdf7c58e?q=80&w=2574&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
        }
        /* เทคนิค Overlay ให้พื้นหลังดูนวลตาและอ่านข้อความง่าย */
        #root {
            background-color: rgba(241, 245, 249, 0.85); /* สีขาวควันบุหรี่จางๆ */
            min-height: 100vh;
            backdrop-filter: blur(8px); /* เบลอภาพหลังเล็กน้อย */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Wallet, PlusCircle, MinusCircle, CheckCircle2, XCircle, 
            History, User, LogOut, AlertCircle, TrendingUp, TrendingDown, 
            Clock, Building2, Lock, UserPlus, PieChart, CreditCard, 
            ChevronRight, Settings, RefreshCw, Activity, Database, ShieldAlert
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs } from 'firebase/firestore';

        // --- Debug Logger Component ---
        const DiagnosticPanel = ({ logs, clearLogs }) => {
            if (logs.length === 0) return null;
            return (
                <div className="fixed bottom-0 left-0 right-0 bg-slate-900 text-slate-200 p-4 max-h-60 overflow-y-auto z-[100] text-xs font-mono border-t-4 border-rose-500 shadow-2xl">
                    <div className="flex justify-between items-center mb-2 sticky top-0 bg-slate-900 pb-2 border-b border-slate-700">
                        <h3 className="font-bold text-rose-400 flex items-center gap-2"><Activity size={16}/> System Diagnosis</h3>
                        <button onClick={clearLogs} className="text-slate-400 hover:text-white underline">Clear</button>
                    </div>
                    {logs.map((log, i) => (
                        <div key={i} className={`mb-1 p-1 rounded ${log.type === 'error' ? 'bg-rose-900/30 text-rose-300' : 'text-emerald-300'}`}>
                            <span className="opacity-50">[{new Date().toLocaleTimeString()}]</span> {log.msg}
                        </div>
                    ))}
                </div>
            );
        };

        // --- Config Screen ---
        const ConfigScreen = ({ onSave }) => {
            const [configInput, setConfigInput] = useState('');
            const [error, setError] = useState('');

            const handleSave = () => {
                try {
                    let cleaned = configInput.trim();
                    cleaned = cleaned.replace(/^(const|var|let)\s+firebaseConfig\s*=\s*/, '').replace(/;$/, '');
                    const json = new Function('return ' + cleaned)();
                    if (!json || !json.apiKey) throw new Error("ไม่พบค่า apiKey");
                    onSave(json);
                } catch (e) {
                    setError('Format ไม่ถูกต้อง กรุณาก๊อปปี้มาทั้งบรรทัด const firebaseConfig = { ... };');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white/90 backdrop-blur-xl p-8 rounded-2xl shadow-xl max-w-md w-full border border-white/50">
                        <h2 className="text-xl font-bold text-center mb-4 text-slate-800">ตั้งค่าการเชื่อมต่อ</h2>
                        <textarea 
                            value={configInput}
                            onChange={(e) => setConfigInput(e.target.value)}
                            placeholder={'const firebaseConfig = {\n  apiKey: "AIzaSy...",\n  authDomain: "..."\n};'}
                            className="w-full h-48 p-4 border rounded-xl text-xs font-mono mb-4 bg-white/50 focus:ring-2 focus:ring-blue-500 outline-none"
                        ></textarea>
                        {error && <p className="text-rose-500 text-xs mb-4 text-center">{error}</p>}
                        <button onClick={handleSave} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg">บันทึก</button>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [firebaseConfig, setFirebaseConfig] = useState(() => {
                const local = localStorage.getItem('vfs_firebase_config');
                if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
                return local ? JSON.parse(local) : null;
            });
            
            const [logs, setLogs] = useState([]);
            const addLog = (msg, type = 'info') => setLogs(prev => [...prev, { msg, type }]);

            if (!firebaseConfig) {
                return <ConfigScreen onSave={(cfg) => {
                    localStorage.setItem('vfs_firebase_config', JSON.stringify(cfg));
                    setFirebaseConfig(cfg);
                    window.location.reload(); 
                }} />;
            }

            const app = useMemo(() => initializeApp(firebaseConfig), [firebaseConfig]);
            const auth = useMemo(() => getAuth(app), [app]);
            const db = useMemo(() => getFirestore(app), [app]);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'volvo-service-fund';

            const [user, setUser] = useState(null);
            const [currentUserData, setCurrentUserData] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            
            // Data States
            const [transactions, setTransactions] = useState([]);
            const [requests, setRequests] = useState([]);
            const [profiles, setProfiles] = useState([]);
            
            // Modal States
            const [showRequestModal, setShowRequestModal] = useState(false);
            const [showDepositModal, setShowDepositModal] = useState(false);
            const [showRegisterModal, setShowRegisterModal] = useState(false);
            const [selectedProfile, setSelectedProfile] = useState(null);
            const [pinInput, setPinInput] = useState('');
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [depositCategory, setDepositCategory] = useState('scrap');
            const [newName, setNewName] = useState('');
            const [newRole, setNewRole] = useState('staff');
            const [newPin, setNewPin] = useState('');

            // --- Critical Auth & Connection Check ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        addLog('กำลังเชื่อมต่อระบบยืนยันตัวตน (Authentication)...');
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        addLog('ยืนยันตัวตนสำเร็จ! (Auth OK)');
                    } catch (err) {
                        addLog(`เชื่อมต่อ Auth ล้มเหลว: ${err.message}`, 'error');
                        if(err.code === 'auth/admin-restricted-operation' || err.message.includes('configuration')) {
                            alert("⚠️ ข้อผิดพลาด: ระบบ Authentication ยังไม่เปิดใช้งาน\n\nวิธีแก้: ไปที่ Firebase Console > Build > Authentication > Sign-in method > เปิด Anonymous");
                        }
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, (u) => setUser(u));
            }, [auth]);

            // --- Database Listeners ---
            useEffect(() => {
                if (!user) return;
                
                addLog('กำลังเชื่อมต่อฐานข้อมูล (Database)...');
                
                const handleDbError = (err) => {
                    addLog(`อ่านข้อมูลล้มเหลว: ${err.message}`, 'error');
                    if(err.code === 'permission-denied') {
                        alert("⚠️ ข้อผิดพลาด: ไม่ได้รับอนุญาตให้เข้าถึงข้อมูล\n\nวิธีแก้: ไปที่ Firebase Console > Firestore Database > Rules > แก้เป็น 'allow read, write: if true;'");
                    } else if (err.code === 'unimplemented' || err.message.includes('Cloud Firestore')) {
                         alert("⚠️ ข้อผิดพลาด: ฐานข้อมูลยังไม่ถูกสร้าง\n\nวิธีแก้: ไปที่ Firebase Console > Build > Firestore Database > กด Create Database");
                    }
                };

                const unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProfiles(data);
                    
                    // Auto-Seed Logic
                    const hasActiveManager = data.some(u => u.role === 'manager' && u.status === 'active');
                    if (!hasActiveManager) {
                        const existingAdmin = data.find(u => u.name === 'เพิร์ธ' && u.role === 'manager');
                        if (existingAdmin) {
                             if(existingAdmin.status !== 'active') updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', existingAdmin.id), { status: 'active' });
                        } else {
                             addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {
                                name: 'เพิร์ธ', role: 'manager', pin: '2121', status: 'active', createdAt: serverTimestamp()
                            }).then(() => addLog('สร้างผู้จัดการ "เพิร์ธ" สำเร็จ')).catch(e => addLog(`สร้างผู้จัดการล้มเหลว: ${e.message}`, 'error'));
                        }
                    }
                }, handleDbError);

                const unsubTx = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), (snap) => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setTransactions(data);
                }, handleDbError);

                const unsubReq = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setRequests(data);
                }, handleDbError);

                return () => { unsubUsers(); unsubTx(); unsubReq(); };
            }, [user, db, appId]);

            // --- Handlers ---
            const handleLogin = (e) => {
                e.preventDefault();
                if(pinInput === selectedProfile.pin) { setCurrentUserData(selectedProfile); setSelectedProfile(null); setPinInput(''); }
                else alert("รหัส PIN ไม่ถูกต้อง");
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {
                        name: newName, role: newRole, pin: newPin, status: 'pending', createdAt: serverTimestamp()
                    });
                    setShowRegisterModal(false); setNewName(''); setNewPin(''); alert('ส่งคำขอแล้ว');
                } catch (e) { addLog(`ลงทะเบียนพลาด: ${e.message}`, 'error'); alert("ลงทะเบียนไม่ได้: " + e.message); }
            };

            const restoreAdmin = async () => {
                if(!confirm('ยืนยันกู้คืนผู้จัดการ "เพิร์ธ"?')) return;
                try {
                     // Force Create
                     await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {
                        name: 'เพิร์ธ', role: 'manager', pin: '2121', status: 'active', createdAt: serverTimestamp()
                    });
                    alert('สร้างใหม่สำเร็จ! ลองรีเฟรช');
                } catch(e) {
                    addLog(`กู้คืนพลาด: ${e.message}`, 'error');
                    alert(`กู้คืนไม่ได้: ${e.message}\n(ดู Error ในกล่องสีดำด้านล่าง)`);
                }
            };
            
            const submitRequest = async () => {
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), {
                    amount: parseFloat(amount), description, requester: currentUserData.name, requesterId: currentUserData.id, status: 'pending', createdAt: serverTimestamp(), type: 'expense'
                });
                setShowRequestModal(false); setAmount(''); setDescription('');
            };
            
            const submitDeposit = async () => {
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                    amount: parseFloat(amount), description, category: depositCategory, performer: currentUserData.name, type: 'income', createdAt: serverTimestamp()
                });
                setShowDepositModal(false); setAmount(''); setDescription('');
            };

            // --- Utilities ---
            const formatMoney = (num) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(num);
            const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'}) : '-';
            
            // --- UI Components ---
            if (!currentUserData) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="w-full max-w-lg mb-20 animate-in relative z-10">
                            <div className="text-center mb-8">
                                <div className="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center mx-auto mb-4 text-white shadow-xl shadow-blue-500/30">
                                    <Building2 size={40}/>
                                </div>
                                <h1 className="text-3xl font-bold text-slate-800 drop-shadow-sm">Volvo Finance</h1>
                                <p className="text-slate-600 font-medium mt-1">Service Center Fund Management</p>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                {profiles.filter(p => p.status === 'active').map(p => (
                                    <button key={p.id} onClick={() => setSelectedProfile(p)} className="bg-white/80 backdrop-blur-md p-4 rounded-xl shadow-lg border border-white/50 hover:border-blue-500 hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col items-center group">
                                        <div className="w-14 h-14 bg-slate-100 rounded-full flex items-center justify-center font-bold text-lg text-slate-700 mb-2 shadow-inner group-hover:bg-blue-100 group-hover:text-blue-700 transition-colors">{p.name[0]}</div>
                                        <div className="font-bold text-slate-800">{p.name}</div>
                                        <div className="text-xs text-slate-500 uppercase font-medium">{p.role}</div>
                                    </button>
                                ))}
                                <button onClick={() => setShowRegisterModal(true)} className="bg-white/50 backdrop-blur-sm border-2 border-dashed border-slate-300 rounded-xl p-4 flex flex-col items-center justify-center text-slate-500 hover:bg-white/80 hover:text-blue-600 hover:border-blue-400 transition-all shadow-sm">
                                    <PlusCircle size={32} className="mb-2"/> <span className="font-medium">สมัครใหม่</span>
                                </button>
                            </div>
                            
                            <button onClick={restoreAdmin} className="w-full text-center text-xs text-slate-500 hover:text-blue-700 flex items-center justify-center gap-1 bg-white/60 backdrop-blur px-4 py-2 rounded-full mx-auto max-w-fit shadow-sm border border-white/50 transition-all">
                                <RefreshCw size={12}/> กู้คืนผู้จัดการ (Emergency Restore)
                            </button>
                        </div>

                        {/* PIN Modal */}
                        {selectedProfile && (
                            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in">
                                <div className="bg-white/90 backdrop-blur-xl p-8 rounded-2xl w-full max-w-xs text-center shadow-2xl border border-white/50">
                                    <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 font-bold text-2xl shadow-inner">
                                        {selectedProfile.name[0]}
                                    </div>
                                    <h3 className="font-bold text-xl mb-1 text-slate-800">ยินดีต้อนรับ</h3>
                                    <p className="text-slate-500 mb-6 font-medium">คุณ {selectedProfile.name}</p>
                                    
                                    <input type="password" maxLength="6" className="w-full text-center text-3xl tracking-[0.5em] border-b-2 border-slate-200 focus:border-blue-500 outline-none py-2 mb-8 bg-transparent font-mono text-slate-800 placeholder-slate-300 transition-all" autoFocus value={pinInput} onChange={e=>setPinInput(e.target.value)} placeholder="••••"/>
                                    
                                    <div className="flex gap-3">
                                        <button onClick={()=>setSelectedProfile(null)} className="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-medium hover:bg-slate-200 transition-colors">ยกเลิก</button>
                                        <button onClick={handleLogin} className="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all transform active:scale-95">เข้าสู่ระบบ</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Register Modal */}
                        {showRegisterModal && (
                            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in">
                                <div className="bg-white/95 backdrop-blur-xl p-6 rounded-2xl w-full max-w-sm shadow-2xl border border-white/50">
                                    <h3 className="font-bold text-xl mb-6 text-slate-800 flex items-center gap-2">
                                        <div className="bg-blue-100 p-2 rounded-lg text-blue-600"><UserPlus size={20}/></div> สมัครสมาชิกใหม่
                                    </h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">ชื่อเรียก (Nickname)</label>
                                            <input className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="เช่น สมชาย" value={newName} onChange={e=>setNewName(e.target.value)}/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">ตำแหน่ง</label>
                                            <div className="flex gap-2 p-1 bg-slate-100 rounded-xl">
                                                <button onClick={()=>setNewRole('staff')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${newRole==='staff'?'bg-white text-blue-700 shadow-sm':'text-slate-500 hover:text-slate-700'}`}>พนักงาน</button>
                                                <button onClick={()=>setNewRole('manager')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${newRole==='manager'?'bg-white text-blue-700 shadow-sm':'text-slate-500 hover:text-slate-700'}`}>ผู้จัดการ</button>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">ตั้งรหัส PIN (4 หลัก)</label>
                                            <input className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-center tracking-widest font-mono text-lg transition-all" placeholder="0000" maxLength="4" value={newPin} onChange={e=>setNewPin(e.target.value)}/>
                                        </div>
                                        <div className="flex gap-3 pt-4">
                                            <button onClick={()=>setShowRegisterModal(false)} className="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-medium hover:bg-slate-200 transition-colors">ยกเลิก</button>
                                            <button onClick={handleRegister} className="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all transform active:scale-95">ยืนยัน</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <DiagnosticPanel logs={logs} clearLogs={()=>setLogs([])} />
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white/80 backdrop-blur-md px-4 py-3 shadow-sm sticky top-0 z-20 flex justify-between items-center border-b border-slate-200/50">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-500/20">V</div>
                            <div><h1 className="font-bold text-slate-800">Volvo Finance</h1><div className="text-xs text-slate-500 font-medium">{currentUserData.name} <span className="bg-slate-100 px-1.5 py-0.5 rounded text-[10px] uppercase ml-1 border border-slate-200">{currentUserData.role}</span></div></div>
                        </div>
                        <button onClick={()=>{setCurrentUserData(null); setActiveTab('dashboard');}} className="p-2 rounded-lg hover:bg-slate-100 text-slate-400 transition-colors"><LogOut size={20} /></button>
                    </header>
                    
                    <main className="p-4 space-y-5 max-w-3xl mx-auto">
                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                            <div className="absolute bottom-0 left-0 w-24 h-24 bg-blue-500/20 rounded-full blur-2xl -ml-5 -mb-5 transition-transform group-hover:scale-110"></div>
                            
                            <div className="relative z-10">
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex items-center gap-2 text-slate-400 text-xs font-medium tracking-wider bg-white/10 px-3 py-1 rounded-full backdrop-blur-md"><CreditCard size={12}/> SERVICE FUND</div>
                                    <Building2 className="text-slate-600" size={24}/>
                                </div>
                                <div className="text-5xl font-bold tracking-tight mb-1">{formatMoney(balance).split('.')[0]}<span className="text-2xl text-slate-400 font-normal">.{formatMoney(balance).split('.')[1]}</span></div>
                                <div className="text-slate-400 text-xs mt-2">ยอดเงินคงเหลือปัจจุบัน</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={()=>setShowRequestModal(true)} className="bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-sm border border-white/50 flex items-center gap-4 hover:shadow-md hover:scale-[1.02] transition-all group">
                                <div className="bg-blue-50 text-blue-600 w-12 h-12 rounded-xl flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors"><MinusCircle size={24}/></div>
                                <div className="text-left"><div className="font-bold text-slate-800">เบิกเงิน</div><div className="text-xs text-slate-500 font-medium">Request Expense</div></div>
                            </button>
                            {currentUserData.role === 'manager' && (
                            <button onClick={()=>setShowDepositModal(true)} className="bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-sm border border-white/50 flex items-center gap-4 hover:shadow-md hover:scale-[1.02] transition-all group">
                                <div className="bg-emerald-50 text-emerald-600 w-12 h-12 rounded-xl flex items-center justify-center group-hover:bg-emerald-600 group-hover:text-white transition-colors"><PlusCircle size={24}/></div>
                                <div className="text-left"><div className="font-bold text-slate-800">เติมเงิน</div><div className="text-xs text-slate-500 font-medium">Add Deposit</div></div>
                            </button>
                            )}
                        </div>
                        
                        {/* Tabs */}
                        <div className="flex bg-slate-200/50 p-1.5 rounded-2xl text-sm font-medium text-slate-500 backdrop-blur-sm">
                             <button onClick={()=>setActiveTab('dashboard')} className={`flex-1 py-2.5 rounded-xl transition-all ${activeTab==='dashboard'?'bg-white text-blue-700 shadow-sm font-bold':'hover:text-slate-700'}`}>ภาพรวม</button>
                             <button onClick={()=>setActiveTab('myRequests')} className={`flex-1 py-2.5 rounded-xl transition-all ${activeTab==='myRequests'?'bg-white text-blue-700 shadow-sm font-bold':'hover:text-slate-700'}`}>ประวัติของฉัน</button>
                             {currentUserData.role === 'manager' && (
                                <button onClick={()=>setActiveTab('approvals')} className={`flex-1 py-2.5 rounded-xl transition-all flex items-center justify-center gap-2 ${activeTab==='approvals'?'bg-white text-blue-700 shadow-sm font-bold':'hover:text-slate-700'}`}>
                                    อนุมัติ {totalPending > 0 && <span className="bg-rose-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">{totalPending}</span>}
                                </button>
                             )}
                        </div>
                        
                        {/* Dashboard Tab */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-3 animate-in">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2 px-1"><History size={18} className="text-blue-500"/> รายการล่าสุด</h3>
                                {transactions.length === 0 ? <div className="text-center py-12 text-slate-400 bg-white/50 rounded-2xl border border-dashed border-slate-300">ไม่มีรายการเคลื่อนไหว</div> :
                                transactions.map(tx => (
                                    <div key={tx.id} className="bg-white/90 backdrop-blur-sm p-4 rounded-2xl border border-white/50 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow">
                                        <div className="flex items-center gap-4">
                                            <div className={`w-12 h-12 rounded-xl flex items-center justify-center shadow-sm ${tx.type==='income'?'bg-emerald-50 text-emerald-600':'bg-slate-50 text-slate-500'}`}>
                                                {tx.type==='income'?<TrendingUp size={20}/>:<TrendingDown size={20}/>}
                                            </div>
                                            <div>
                                                <div className="font-bold text-slate-800">{tx.description}</div>
                                                <div className="text-xs text-slate-400 font-medium mt-0.5 flex items-center gap-1"><Clock size={10}/> {formatDate(tx.createdAt)} • {tx.performer}</div>
                                            </div>
                                        </div>
                                        <div className={`font-bold text-lg ${tx.type==='income'?'text-emerald-600':'text-slate-700'}`}>{tx.type==='income'?'+':'-'}{formatMoney(tx.amount)}</div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {/* My Requests Tab */}
                        {activeTab === 'myRequests' && (
                            <div className="space-y-3 animate-in">
                                {requests.filter(r => currentUserData.role === 'manager' || r.requester === currentUserData.name).length === 0 ? 
                                <div className="text-center py-12 text-slate-400 bg-white/50 rounded-2xl border border-dashed border-slate-300">ไม่มีประวัติการทำรายการ</div> :
                                requests.filter(r => currentUserData.role === 'manager' || r.requester === currentUserData.name).map(req => (
                                    <div key={req.id} className="bg-white/90 backdrop-blur-sm p-5 rounded-2xl border border-white/50 shadow-sm hover:shadow-md transition-shadow">
                                        <div className="flex justify-between mb-3">
                                            <div className="font-bold text-slate-800 text-lg">{req.description}</div>
                                            <span className={`text-[10px] px-2.5 py-1 rounded-lg uppercase font-bold tracking-wide h-fit border ${req.status==='pending'?'bg-amber-50 text-amber-600 border-amber-100':req.status==='approved'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-rose-50 text-rose-600 border-rose-100'}`}>{req.status}</span>
                                        </div>
                                        <div className="flex justify-between text-sm items-end border-t border-slate-100 pt-3">
                                            <div className="text-slate-400 font-medium flex items-center gap-1"><Clock size={12}/> {formatDate(req.createdAt)}</div>
                                            <div className="font-bold text-xl text-slate-800">{formatMoney(req.amount)}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Approvals Tab */}
                        {activeTab === 'approvals' && (
                            <div className="space-y-6 animate-in">
                                {pendingUsers.length > 0 && (
                                    <div className="space-y-3">
                                        <h4 className="font-bold text-sm text-slate-600 flex items-center gap-2 px-1"><UserPlus size={16} className="text-blue-500"/> ผู้ใช้ใหม่ ({pendingUsers.length})</h4>
                                        {pendingUsers.map(u => (
                                            <div key={u.id} className="bg-blue-50/80 backdrop-blur-sm border border-blue-100 p-4 rounded-2xl flex justify-between items-center shadow-sm">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center font-bold text-blue-600 shadow-sm border border-blue-100">{u.name[0]}</div>
                                                    <div><div className="font-bold text-slate-800">{u.name}</div><div className="text-xs text-slate-500 uppercase font-medium bg-white px-2 py-0.5 rounded border border-blue-100 w-fit">{u.role}</div></div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={()=>updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {status:'active'})} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all">อนุมัติ</button>
                                                    <button onClick={()=>deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id))} className="bg-white text-rose-500 border border-rose-200 px-4 py-2 rounded-xl text-sm font-bold hover:bg-rose-50 transition-all">ลบ</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="space-y-3">
                                    <h4 className="font-bold text-sm text-slate-600 flex items-center gap-2 px-1"><Wallet size={16} className="text-amber-500"/> รายการเบิก ({pendingRequests.length})</h4>
                                    {pendingRequests.length === 0 ? <div className="text-center py-8 text-slate-400 bg-white/50 rounded-2xl border border-dashed border-slate-300">ไม่มีรายการรออนุมัติ</div> :
                                    pendingRequests.map(req => (
                                        <div key={req.id} className="bg-white/90 backdrop-blur-sm border-l-4 border-l-amber-400 p-5 rounded-2xl shadow-sm hover:shadow-md transition-all border-y border-r border-white/50">
                                            <div className="flex justify-between mb-2">
                                                <div>
                                                    <div className="font-bold text-xl text-slate-800">{req.description}</div>
                                                    <div className="text-xs text-slate-500 font-medium bg-slate-100 px-2 py-1 rounded-lg w-fit mt-1 flex items-center gap-1"><User size={10}/> ขอโดย {req.requester}</div>
                                                </div>
                                                <div className="font-bold text-2xl text-slate-800">{formatMoney(req.amount)}</div>
                                            </div>
                                            <div className="flex gap-3 pt-4 border-t border-slate-100 mt-2">
                                                <button onClick={async ()=>{
                                                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), { amount: parseFloat(req.amount), description: req.description, performer: req.requester, approver: currentUserData.name, type: 'expense', createdAt: serverTimestamp() });
                                                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', req.id), { status: 'approved' });
                                                }} className="flex-1 bg-emerald-600 text-white py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-emerald-500/30 hover:bg-emerald-700 transition-all">อนุมัติ</button>
                                                <button onClick={()=>updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', req.id), { status: 'rejected' })} className="flex-1 bg-white border border-slate-200 text-slate-600 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-50 transition-all">ปฏิเสธ</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                    </main>
                    <DiagnosticPanel logs={logs} clearLogs={()=>setLogs([])} />
                    
                    {/* Modals for Requests/Deposits inline (Simplified) */}
                    {showRequestModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                                <h3 className="font-bold text-xl mb-6 text-slate-800 flex items-center gap-2"><div className="bg-blue-100 p-1.5 rounded-lg text-blue-600"><MinusCircle size={20}/></div> ขอเบิกเงิน</h3>
                                <input className="w-full border p-3.5 rounded-xl mb-3 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="รายการค่าใช้จ่าย" value={description} onChange={e=>setDescription(e.target.value)} autoFocus/>
                                <input className="w-full border p-3.5 rounded-xl mb-6 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all text-lg font-medium" type="number" placeholder="จำนวนเงิน" value={amount} onChange={e=>setAmount(e.target.value)}/>
                                <div className="flex gap-3">
                                    <button onClick={()=>setShowRequestModal(false)} className="flex-1 py-3 bg-slate-100 rounded-xl text-slate-600 font-bold hover:bg-slate-200 transition-colors">ยกเลิก</button>
                                    <button onClick={submitRequest} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all">ส่งคำขอ</button>
                                </div>
                            </div>
                        </div>
                    )}
                     {showDepositModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                                <h3 className="font-bold text-xl mb-6 text-slate-800 flex items-center gap-2"><div className="bg-emerald-100 p-1.5 rounded-lg text-emerald-600"><PlusCircle size={20}/></div> เติมเงินเข้ากองกลาง</h3>
                                <select className="w-full border p-3.5 rounded-xl mb-3 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition-all" value={depositCategory} onChange={e=>setDepositCategory(e.target.value)}>
                                    {INCOME_CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.icon} {c.label}</option>)}
                                </select>
                                <input className="w-full border p-3.5 rounded-xl mb-3 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition-all" placeholder="รายละเอียดเพิ่มเติม" value={description} onChange={e=>setDescription(e.target.value)} />
                                <input className="w-full border p-3.5 rounded-xl mb-6 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none transition-all text-lg font-medium" type="number" placeholder="จำนวนเงิน" value={amount} onChange={e=>setAmount(e.target.value)}/>
                                <div className="flex gap-3">
                                    <button onClick={()=>setShowDepositModal(false)} className="flex-1 py-3 bg-slate-100 rounded-xl text-slate-600 font-bold hover:bg-slate-200 transition-colors">ยกเลิก</button>
                                    <button onClick={submitDeposit} className="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/30 hover:bg-emerald-700 transition-all">ยืนยัน</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>