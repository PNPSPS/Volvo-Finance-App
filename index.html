<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volvo Finance Service (Debug Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.309.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style> body { font-family: 'Prompt', sans-serif; background-color: #F8FAFC; } </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Wallet, PlusCircle, MinusCircle, CheckCircle2, XCircle, 
            History, User, LogOut, AlertCircle, TrendingUp, TrendingDown, 
            Clock, Building2, Lock, UserPlus, PieChart, CreditCard, 
            ChevronRight, Settings, RefreshCw, Activity, Database, ShieldAlert
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs } from 'firebase/firestore';

        // --- Debug Logger Component ---
        const DiagnosticPanel = ({ logs, clearLogs }) => {
            if (logs.length === 0) return null;
            return (
                <div className="fixed bottom-0 left-0 right-0 bg-slate-900 text-slate-200 p-4 max-h-60 overflow-y-auto z-[100] text-xs font-mono border-t-4 border-rose-500 shadow-2xl">
                    <div className="flex justify-between items-center mb-2 sticky top-0 bg-slate-900 pb-2 border-b border-slate-700">
                        <h3 className="font-bold text-rose-400 flex items-center gap-2"><Activity size={16}/> System Diagnosis</h3>
                        <button onClick={clearLogs} className="text-slate-400 hover:text-white underline">Clear</button>
                    </div>
                    {logs.map((log, i) => (
                        <div key={i} className={`mb-1 p-1 rounded ${log.type === 'error' ? 'bg-rose-900/30 text-rose-300' : 'text-emerald-300'}`}>
                            <span className="opacity-50">[{new Date().toLocaleTimeString()}]</span> {log.msg}
                        </div>
                    ))}
                </div>
            );
        };

        // --- Config Screen ---
        const ConfigScreen = ({ onSave }) => {
            const [configInput, setConfigInput] = useState('');
            const [error, setError] = useState('');

            const handleSave = () => {
                try {
                    let cleaned = configInput.trim();
                    cleaned = cleaned.replace(/^(const|var|let)\s+firebaseConfig\s*=\s*/, '').replace(/;$/, '');
                    const json = new Function('return ' + cleaned)();
                    if (!json || !json.apiKey) throw new Error("ไม่พบค่า apiKey");
                    onSave(json);
                } catch (e) {
                    setError('Format ไม่ถูกต้อง กรุณาก๊อปปี้มาทั้งบรรทัด const firebaseConfig = { ... };');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-100">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full">
                        <h2 className="text-xl font-bold text-center mb-4">ตั้งค่าการเชื่อมต่อ</h2>
                        <textarea 
                            value={configInput}
                            onChange={(e) => setConfigInput(e.target.value)}
                            placeholder={'const firebaseConfig = {\n  apiKey: "AIzaSy...",\n  authDomain: "..."\n};'}
                            className="w-full h-48 p-4 border rounded-xl text-xs font-mono mb-4 bg-slate-50"
                        ></textarea>
                        {error && <p className="text-rose-500 text-xs mb-4 text-center">{error}</p>}
                        <button onClick={handleSave} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">บันทึก</button>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [firebaseConfig, setFirebaseConfig] = useState(() => {
                const local = localStorage.getItem('vfs_firebase_config');
                if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
                return local ? JSON.parse(local) : null;
            });
            
            const [logs, setLogs] = useState([]);
            const addLog = (msg, type = 'info') => setLogs(prev => [...prev, { msg, type }]);

            if (!firebaseConfig) {
                return <ConfigScreen onSave={(cfg) => {
                    localStorage.setItem('vfs_firebase_config', JSON.stringify(cfg));
                    setFirebaseConfig(cfg);
                    window.location.reload(); 
                }} />;
            }

            const app = useMemo(() => initializeApp(firebaseConfig), [firebaseConfig]);
            const auth = useMemo(() => getAuth(app), [app]);
            const db = useMemo(() => getFirestore(app), [app]);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'volvo-service-fund';

            const [user, setUser] = useState(null);
            const [currentUserData, setCurrentUserData] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            
            // Data States
            const [transactions, setTransactions] = useState([]);
            const [requests, setRequests] = useState([]);
            const [profiles, setProfiles] = useState([]);
            
            // Modal States
            const [showRequestModal, setShowRequestModal] = useState(false);
            const [showDepositModal, setShowDepositModal] = useState(false);
            const [showRegisterModal, setShowRegisterModal] = useState(false);
            const [selectedProfile, setSelectedProfile] = useState(null);
            const [pinInput, setPinInput] = useState('');
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [depositCategory, setDepositCategory] = useState('scrap');
            const [newName, setNewName] = useState('');
            const [newRole, setNewRole] = useState('staff');
            const [newPin, setNewPin] = useState('');

            // --- Critical Auth & Connection Check ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        addLog('กำลังเชื่อมต่อระบบยืนยันตัวตน (Authentication)...');
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        addLog('ยืนยันตัวตนสำเร็จ! (Auth OK)');
                    } catch (err) {
                        addLog(`เชื่อมต่อ Auth ล้มเหลว: ${err.message}`, 'error');
                        if(err.code === 'auth/admin-restricted-operation' || err.message.includes('configuration')) {
                            alert("⚠️ ข้อผิดพลาด: ระบบ Authentication ยังไม่เปิดใช้งาน\n\nวิธีแก้: ไปที่ Firebase Console > Build > Authentication > Sign-in method > เปิด Anonymous");
                        }
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, (u) => setUser(u));
            }, [auth]);

            // --- Database Listeners ---
            useEffect(() => {
                if (!user) return;
                
                addLog('กำลังเชื่อมต่อฐานข้อมูล (Database)...');
                
                const handleDbError = (err) => {
                    addLog(`อ่านข้อมูลล้มเหลว: ${err.message}`, 'error');
                    if(err.code === 'permission-denied') {
                        alert("⚠️ ข้อผิดพลาด: ไม่ได้รับอนุญาตให้เข้าถึงข้อมูล\n\nวิธีแก้: ไปที่ Firebase Console > Firestore Database > Rules > แก้เป็น 'allow read, write: if true;'");
                    } else if (err.code === 'unimplemented' || err.message.includes('Cloud Firestore')) {
                         alert("⚠️ ข้อผิดพลาด: ฐานข้อมูลยังไม่ถูกสร้าง\n\nวิธีแก้: ไปที่ Firebase Console > Build > Firestore Database > กด Create Database");
                    }
                };

                const unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProfiles(data);
                    
                    // Auto-Seed Logic
                    const hasActiveManager = data.some(u => u.role === 'manager' && u.status === 'active');
                    if (!hasActiveManager) {
                        const existingAdmin = data.find(u => u.name === 'เพิร์ธ' && u.role === 'manager');
                        if (existingAdmin) {
                             if(existingAdmin.status !== 'active') updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', existingAdmin.id), { status: 'active' });
                        } else {
                             addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {
                                name: 'เพิร์ธ', role: 'manager', pin: '2121', status: 'active', createdAt: serverTimestamp()
                            }).then(() => addLog('สร้างผู้จัดการ "เพิร์ธ" สำเร็จ')).catch(e => addLog(`สร้างผู้จัดการล้มเหลว: ${e.message}`, 'error'));
                        }
                    }
                }, handleDbError);

                const unsubTx = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), (snap) => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setTransactions(data);
                }, handleDbError);

                const unsubReq = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setRequests(data);
                }, handleDbError);

                return () => { unsubUsers(); unsubTx(); unsubReq(); };
            }, [user, db, appId]);

            // --- Handlers ---
            const handleLogin = (e) => {
                e.preventDefault();
                if(pinInput === selectedProfile.pin) { setCurrentUserData(selectedProfile); setSelectedProfile(null); setPinInput(''); }
                else alert("รหัส PIN ไม่ถูกต้อง");
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {
                        name: newName, role: newRole, pin: newPin, status: 'pending', createdAt: serverTimestamp()
                    });
                    setShowRegisterModal(false); setNewName(''); setNewPin(''); alert('ส่งคำขอแล้ว');
                } catch (e) { addLog(`ลงทะเบียนพลาด: ${e.message}`, 'error'); alert("ลงทะเบียนไม่ได้: " + e.message); }
            };

            const restoreAdmin = async () => {
                if(!confirm('ยืนยันกู้คืนผู้จัดการ "เพิร์ธ"?')) return;
                try {
                     // Force Create
                     await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {
                        name: 'เพิร์ธ', role: 'manager', pin: '2121', status: 'active', createdAt: serverTimestamp()
                    });
                    alert('สร้างใหม่สำเร็จ! ลองรีเฟรช');
                } catch(e) {
                    addLog(`กู้คืนพลาด: ${e.message}`, 'error');
                    alert(`กู้คืนไม่ได้: ${e.message}\n(ดู Error ในกล่องสีดำด้านล่าง)`);
                }
            };
            
            const submitRequest = async () => {
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), {
                    amount: parseFloat(amount), description, requester: currentUserData.name, requesterId: currentUserData.id, status: 'pending', createdAt: serverTimestamp(), type: 'expense'
                });
                setShowRequestModal(false); setAmount(''); setDescription('');
            };
            
            const submitDeposit = async () => {
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                    amount: parseFloat(amount), description, category: depositCategory, performer: currentUserData.name, type: 'income', createdAt: serverTimestamp()
                });
                setShowDepositModal(false); setAmount(''); setDescription('');
            };

            // --- Utilities ---
            const formatMoney = (num) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(num);
            const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'}) : '-';
            
            // --- UI Components ---
            if (!currentUserData) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
                        <div className="w-full max-w-lg mb-20 animate-in">
                            <div className="text-center mb-8">
                                <div className="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-white shadow-xl"><Building2 size={40}/></div>
                                <h1 className="text-3xl font-bold text-slate-800">Volvo Finance</h1>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                {profiles.filter(p => p.status === 'active').map(p => (
                                    <button key={p.id} onClick={() => setSelectedProfile(p)} className="bg-white p-4 rounded-xl shadow-sm border hover:border-blue-500 hover:shadow-md transition-all flex flex-col items-center">
                                        <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center font-bold text-slate-600 mb-2">{p.name[0]}</div>
                                        <div className="font-bold">{p.name}</div>
                                        <div className="text-xs text-slate-500 uppercase">{p.role}</div>
                                    </button>
                                ))}
                                <button onClick={() => setShowRegisterModal(true)} className="bg-slate-50 border-2 border-dashed rounded-xl p-4 flex flex-col items-center justify-center text-slate-400 hover:bg-slate-100">
                                    <PlusCircle size={32} className="mb-2"/> <span>สมัครใหม่</span>
                                </button>
                            </div>
                            
                            <button onClick={restoreAdmin} className="w-full text-center text-xs text-slate-400 hover:text-blue-600 flex items-center justify-center gap-1">
                                <RefreshCw size={12}/> กู้คืนผู้จัดการ (Emergency Restore)
                            </button>
                        </div>

                        {/* PIN Modal */}
                        {selectedProfile && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-xs text-center">
                                    <h3 className="font-bold text-lg mb-4">สวัสดี {selectedProfile.name}</h3>
                                    <input type="password" maxLength="6" className="w-full text-center text-3xl tracking-widest border-b-2 border-slate-200 focus:border-blue-500 outline-none py-2 mb-6" autoFocus value={pinInput} onChange={e=>setPinInput(e.target.value)} placeholder="PIN"/>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setSelectedProfile(null)} className="flex-1 py-2 rounded-lg bg-slate-100">ยกเลิก</button>
                                        <button onClick={handleLogin} className="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold">เข้าสู่ระบบ</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Register Modal */}
                        {showRegisterModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm">
                                    <h3 className="font-bold text-lg mb-4">สมัครสมาชิกใหม่</h3>
                                    <div className="space-y-4">
                                        <input className="w-full p-3 border rounded-lg" placeholder="ชื่อเล่น" value={newName} onChange={e=>setNewName(e.target.value)}/>
                                        <div className="flex gap-2">
                                            <button onClick={()=>setNewRole('staff')} className={`flex-1 p-2 rounded border ${newRole==='staff'?'bg-blue-50 border-blue-500 text-blue-700':''}`}>พนักงาน</button>
                                            <button onClick={()=>setNewRole('manager')} className={`flex-1 p-2 rounded border ${newRole==='manager'?'bg-blue-50 border-blue-500 text-blue-700':''}`}>ผู้จัดการ</button>
                                        </div>
                                        <input className="w-full p-3 border rounded-lg text-center tracking-widest" placeholder="ตั้งรหัส PIN 4 หลัก" maxLength="4" value={newPin} onChange={e=>setNewPin(e.target.value)}/>
                                        <div className="flex gap-2 pt-2">
                                            <button onClick={()=>setShowRegisterModal(false)} className="flex-1 py-2 rounded-lg bg-slate-100">ยกเลิก</button>
                                            <button onClick={handleRegister} className="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold">ยืนยัน</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <DiagnosticPanel logs={logs} clearLogs={()=>setLogs([])} />
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    <header className="bg-white px-4 py-3 shadow-sm sticky top-0 z-20 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-xl">V</div>
                            <div><h1 className="font-bold">Volvo Finance</h1><div className="text-xs text-slate-500">{currentUserData.name} ({currentUserData.role})</div></div>
                        </div>
                        <button onClick={()=>{setCurrentUserData(null); setActiveTab('dashboard');}}><LogOut size={20} className="text-slate-400"/></button>
                    </header>
                    
                    <main className="p-4 space-y-4 max-w-3xl mx-auto">
                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white shadow-xl">
                            <div className="flex items-center gap-2 text-slate-400 text-xs mb-2"><CreditCard size={14}/> SERVICE FUND BALANCE</div>
                            <div className="text-4xl font-bold">{formatMoney(balance)}</div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={()=>setShowRequestModal(true)} className="bg-white p-4 rounded-xl shadow-sm border flex items-center gap-3 hover:bg-blue-50">
                                <div className="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center"><MinusCircle/></div>
                                <div className="text-left"><div className="font-bold">เบิกเงิน</div><div className="text-xs text-slate-400">Request</div></div>
                            </button>
                            {currentUserData.role === 'manager' && (
                            <button onClick={()=>setShowDepositModal(true)} className="bg-white p-4 rounded-xl shadow-sm border flex items-center gap-3 hover:bg-emerald-50">
                                <div className="bg-emerald-100 text-emerald-600 w-10 h-10 rounded-full flex items-center justify-center"><PlusCircle/></div>
                                <div className="text-left"><div className="font-bold">เติมเงิน</div><div className="text-xs text-slate-400">Deposit</div></div>
                            </button>
                            )}
                        </div>
                        
                        {/* Tabs */}
                        <div className="flex bg-slate-200 p-1 rounded-xl text-sm font-medium text-slate-500">
                             <button onClick={()=>setActiveTab('dashboard')} className={`flex-1 py-2 rounded-lg ${activeTab==='dashboard'?'bg-white text-blue-600 shadow-sm':''}`}>ภาพรวม</button>
                             <button onClick={()=>setActiveTab('myRequests')} className={`flex-1 py-2 rounded-lg ${activeTab==='myRequests'?'bg-white text-blue-600 shadow-sm':''}`}>ประวัติ</button>
                             {currentUserData.role === 'manager' && (
                                <button onClick={()=>setActiveTab('approvals')} className={`flex-1 py-2 rounded-lg ${activeTab==='approvals'?'bg-white text-blue-600 shadow-sm':''}`}>อนุมัติ ({totalPending})</button>
                             )}
                        </div>
                        
                        {/* Dashboard Tab */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-3">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><History size={16}/> รายการล่าสุด</h3>
                                {transactions.map(tx => (
                                    <div key={tx.id} className="bg-white p-3 rounded-xl border flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${tx.type==='income'?'bg-emerald-100 text-emerald-600':'bg-slate-100 text-slate-500'}`}>
                                                {tx.type==='income'?<TrendingUp size={20}/>:<TrendingDown size={20}/>}
                                            </div>
                                            <div><div className="font-bold text-sm">{tx.description}</div><div className="text-xs text-slate-400">{formatDate(tx.createdAt)} • {tx.performer}</div></div>
                                        </div>
                                        <div className={`font-bold ${tx.type==='income'?'text-emerald-600':'text-slate-800'}`}>{tx.type==='income'?'+':'-'}{formatMoney(tx.amount)}</div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {/* My Requests Tab */}
                        {activeTab === 'myRequests' && (
                            <div className="space-y-3">
                                {requests.filter(r => currentUserData.role === 'manager' || r.requester === currentUserData.name).map(req => (
                                    <div key={req.id} className="bg-white p-4 rounded-xl border shadow-sm">
                                        <div className="flex justify-between mb-2">
                                            <div className="font-bold">{req.description}</div>
                                            <span className={`text-[10px] px-2 py-1 rounded uppercase ${req.status==='pending'?'bg-amber-100 text-amber-700':req.status==='approved'?'bg-emerald-100 text-emerald-700':'bg-rose-100 text-rose-700'}`}>{req.status}</span>
                                        </div>
                                        <div className="flex justify-between text-sm items-end">
                                            <div className="text-slate-400">{formatDate(req.createdAt)}</div>
                                            <div className="font-bold text-lg">{formatMoney(req.amount)}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Approvals Tab */}
                        {activeTab === 'approvals' && (
                            <div className="space-y-6">
                                {pendingUsers.length > 0 && (
                                    <div className="space-y-2">
                                        <h4 className="font-bold text-sm text-slate-500">ผู้ใช้ใหม่ ({pendingUsers.length})</h4>
                                        {pendingUsers.map(u => (
                                            <div key={u.id} className="bg-blue-50 border border-blue-100 p-3 rounded-xl flex justify-between items-center">
                                                <div className="font-bold text-blue-900">{u.name} <span className="text-xs font-normal opacity-70">({u.role})</span></div>
                                                <div className="flex gap-2">
                                                    <button onClick={()=>updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), {status:'active'})} className="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">อนุมัติ</button>
                                                    <button onClick={()=>deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id))} className="text-rose-500 px-3 py-1 text-sm">ลบ</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="space-y-2">
                                    <h4 className="font-bold text-sm text-slate-500">รายการเบิก ({pendingRequests.length})</h4>
                                    {pendingRequests.map(req => (
                                        <div key={req.id} className="bg-white border-l-4 border-l-amber-400 p-4 rounded-xl shadow-sm">
                                            <div className="flex justify-between mb-2">
                                                <div><div className="font-bold text-lg">{req.description}</div><div className="text-xs text-slate-400">โดย {req.requester}</div></div>
                                                <div className="font-bold text-xl">{formatMoney(req.amount)}</div>
                                            </div>
                                            <div className="flex gap-2 pt-2 border-t mt-2">
                                                <button onClick={async ()=>{
                                                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), { amount: parseFloat(req.amount), description: req.description, performer: req.requester, approver: currentUserData.name, type: 'expense', createdAt: serverTimestamp() });
                                                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', req.id), { status: 'approved' });
                                                }} className="flex-1 bg-emerald-600 text-white py-2 rounded-lg text-sm font-bold">อนุมัติ</button>
                                                <button onClick={()=>updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', req.id), { status: 'rejected' })} className="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg text-sm">ปฏิเสธ</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                    </main>
                    <DiagnosticPanel logs={logs} clearLogs={()=>setLogs([])} />
                    
                    {/* Modals for Requests/Deposits inline (Simplified) */}
                    {showRequestModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm">
                                <h3 className="font-bold text-lg mb-4">ขอเบิกเงิน</h3>
                                <input className="w-full border p-3 rounded-xl mb-3" placeholder="รายการ" value={description} onChange={e=>setDescription(e.target.value)} autoFocus/>
                                <input className="w-full border p-3 rounded-xl mb-4" type="number" placeholder="จำนวนเงิน" value={amount} onChange={e=>setAmount(e.target.value)}/>
                                <div className="flex gap-2">
                                    <button onClick={()=>setShowRequestModal(false)} className="flex-1 py-3 bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={submitRequest} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">ส่ง</button>
                                </div>
                            </div>
                        </div>
                    )}
                     {showDepositModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm">
                                <h3 className="font-bold text-lg mb-4">เติมเงินเข้ากองกลาง</h3>
                                <input className="w-full border p-3 rounded-xl mb-3" placeholder="รายละเอียด" value={description} onChange={e=>setDescription(e.target.value)} autoFocus/>
                                <input className="w-full border p-3 rounded-xl mb-4" type="number" placeholder="จำนวนเงิน" value={amount} onChange={e=>setAmount(e.target.value)}/>
                                <div className="flex gap-2">
                                    <button onClick={()=>setShowDepositModal(false)} className="flex-1 py-3 bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={submitDeposit} className="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold">ยืนยัน</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>