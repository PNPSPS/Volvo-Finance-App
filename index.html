import React, { useState, useEffect } from 'react';
import { 
  PlusCircle, 
  MinusCircle, 
  Wallet, 
  Clock, 
  CheckCircle2, 
  XCircle, 
  User, 
  Briefcase, 
  PieChart, 
  Activity,
  ChevronRight,
  Filter,
  Trash2,
  TrendingUp,
  TrendingDown,
  Calendar,
  CloudLightning,
  Lock,
  Unlock,
  Settings,
  Database,
  Wifi,
  WifiOff,
  Save
} from 'lucide-react';

// --- Firebase Imports ---
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  onSnapshot, 
  query 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInWithCustomToken, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';

// --- Firebase Configuration (ใส่ค่าของคุณตรงนี้) ---
// TODO: คุณเพิร์ธนำค่าจาก Firebase Console มาใส่แทนที่ในเครื่องหมายคำพูดด้านล่างนี้ครับ
const firebaseConfig = {
  apiKey:"AIzaSyAmm8CJj4yU6Qclr1_l8yVwcQptOtnh0rE",
  authDomain:"volvo-finance.firebaseapp.com",
  projectId:"volvo-finance",
  storageBucket:"volvo-finance.firebasestorage.app",
  messagingSenderId: "713687952336",
  appId:"1:713687952336:web:00b6a228b36098cf5fe7d5",
  measurementId: "G-HFEWYL8GZ9"
};

// --- Initialization Logic ---
let app, auth, db;
let isConfigured = false;
let appId = 'volvo-main-app';

try {
  // 1. เช็ค Environment Variable (สำหรับ Preview ในนี้)
  if (typeof __firebase_config !== 'undefined') {
     const config = JSON.parse(__firebase_config);
     app = initializeApp(config);
     if (typeof __app_id !== 'undefined') appId = __app_id;
     isConfigured = true;
  } 
  // 2. ถ้าไม่มี ให้เช็คค่า Hardcode ด้านบน
  else if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "ใส่ค่า_apiKey_ที่นี่") {
     app = initializeApp(firebaseConfig);
     isConfigured = true;
  }
  
  if (isConfigured) {
    auth = getAuth(app);
    db = getFirestore(app);
  }
} catch (e) {
  console.error("Init Error", e);
}

// --- Main App Component ---
const App = () => {
  // --- State Management ---
  const [user, setUser] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(true);

  // UI State
  const [view, setView] = useState('dashboard');
  const [currentUserRole, setCurrentUserRole] = useState('staff');
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState('expense');
  const [filterType, setFilterType] = useState('all');
  
  // Settings & Auth State
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const [authError, setAuthError] = useState('');

  // --- 1. Authentication Effect (ทำงานเมื่อเริ่มแอป) ---
  useEffect(() => {
    // ถ้าไม่ได้ตั้งค่า Cloud (Offline Mode) ให้ข้าม Auth ไปเลย
    if (!isConfigured || !auth) {
        setLoading(false); 
        return;
    }

    // เริ่มกระบวนการ Login
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) { 
        console.error("Auth Error:", error); 
        // ไม่ต้อง setLoading(false) ที่นี่ รอ onAuthStateChanged
      }
    };
    initAuth();

    // ฟังสถานะ Login
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
        setUser(currentUser);
        // ถ้า Login ไม่ผ่านหรือไม่สำเร็จ ให้หยุดโหลด เพื่อให้หน้าจอแสดงผลได้ (แม้จะเป็น Offline)
        if (!currentUser) setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  // --- 2. Data Sync Effect (ทำงานเมื่อมี User แล้ว) ---
  useEffect(() => {
    // Case 1: Online & Authenticated (สำคัญ: ต้องมี user ก่อนถึงจะ query ได้)
    if (isConfigured && user) {
        setLoading(true); // โหลดหมุนๆ ระหว่างดึงข้อมูล
        
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
        
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            docs.sort((a, b) => new Date(b.date) - new Date(a.date));
            setTransactions(docs);
            setLoading(false);
        }, (err) => {
            console.error("Sync Error", err);
            // ถ้า Error Permission ให้หยุดโหลด
            setLoading(false);
        });

        return () => unsubscribe();
    } 
    
    // Case 2: Offline Mode (โหลดจาก LocalStorage)
    else if (!isConfigured) {
        const savedData = localStorage.getItem('volvo_local_transactions');
        if (savedData) {
            setTransactions(JSON.parse(savedData));
        } else {
            // Mock Data เริ่มต้น
            setTransactions([
              { id: 1, type: 'income', title: 'ตัวอย่าง: รายรับเช็คระยะ (Offline)', amount: 5000, requester: 'System', status: 'approved', date: new Date().toISOString(), category: 'service' },
            ]);
        }
        setLoading(false);
    }
  }, [user]); // dependency array ใส่ user เพื่อให้ทำงานใหม่เมื่อ user เปลี่ยนสถานะ

  // Sync Local Data when transactions change (Only in Offline Mode)
  useEffect(() => {
    if (!isConfigured) {
      localStorage.setItem('volvo_local_transactions', JSON.stringify(transactions));
    }
  }, [transactions]);

  // --- Handlers (Hybrid: Online/Offline) ---
  
  const handleApprove = async (id) => {
    if (isConfigured && user) {
      try {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id.toString());
        await updateDoc(docRef, { status: 'approved' });
      } catch (e) { console.error("Error", e); }
    } else {
      setTransactions(prev => prev.map(t => t.id === id ? { ...t, status: 'approved' } : t));
    }
  };

  const handleReject = async (id) => {
    if (isConfigured && user) {
      try {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id.toString());
        await updateDoc(docRef, { status: 'rejected' });
      } catch (e) { console.error("Error", e); }
    } else {
      setTransactions(prev => prev.map(t => t.id === id ? { ...t, status: 'rejected' } : t));
    }
  };

  const handleDelete = async (id) => {
    if (!confirm('ยืนยันการลบรายการนี้?')) return;
    
    if (isConfigured && user) {
      try {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id.toString());
        await deleteDoc(docRef);
      } catch (e) { console.error("Error", e); }
    } else {
      setTransactions(prev => prev.filter(t => t.id !== id));
    }
  };

  const handleAddTransaction = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newTransaction = {
      type: modalType,
      title: formData.get('title'),
      amount: parseFloat(formData.get('amount')),
      requester: formData.get('requester') || (currentUserRole === 'manager' ? 'คุณเพิร์ธ (ผจก.)' : 'พนักงาน'),
      status: modalType === 'income' ? 'approved' : 'pending',
      date: new Date().toISOString(),
      category: formData.get('category'),
      createdBy: user?.uid || 'local-user'
    };

    if (isConfigured && user) {
      try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), newTransaction);
      } catch (e) { alert("Error adding data"); }
    } else {
      const localTx = { ...newTransaction, id: Date.now() };
      setTransactions(prev => [localTx, ...prev]);
    }
    setShowModal(false);
  };

  // --- Auth Handlers ---
  const handleRoleSwitch = () => {
    if (currentUserRole === 'manager') {
      setCurrentUserRole('staff');
    } else {
      setShowAuthModal(true);
      setPasswordInput('');
      setAuthError('');
    }
  };

  const handleAuthSubmit = (e) => {
    e.preventDefault();
    if (passwordInput === '211221') { 
      setCurrentUserRole('manager');
      setShowAuthModal(false);
    } else {
      setAuthError('รหัสผ่านไม่ถูกต้อง');
      setPasswordInput('');
    }
  };

  // --- Helper Functions ---
  const groupTransactionsByDate = (txs) => {
    const groups = {};
    txs.forEach(t => {
      const date = new Date(t.date).toDateString();
      if (!groups[date]) groups[date] = [];
      groups[date].push(t);
    });
    return groups;
  };

  const getFilteredTransactions = () => {
    let filtered = transactions;
    if (filterType === 'pending') filtered = filtered.filter(t => t.status === 'pending');
    else if (filterType === 'income') filtered = filtered.filter(t => t.type === 'income');
    else if (filterType === 'expense') filtered = filtered.filter(t => t.type === 'expense');
    return filtered;
  };

  const getDateLabel = (dateStr) => {
    const date = new Date(dateStr);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    if (date.toDateString() === today.toDateString()) return 'วันนี้';
    if (date.toDateString() === yesterday.toDateString()) return 'เมื่อวาน';
    return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
  };

  // --- Derived Stats ---
  const totalIncome = transactions.filter(t => t.type === 'income' && t.status === 'approved').reduce((acc, curr) => acc + curr.amount, 0);
  const totalExpense = transactions.filter(t => t.type === 'expense' && t.status === 'approved').reduce((acc, curr) => acc + curr.amount, 0);
  const pendingCount = transactions.filter(t => t.status === 'pending').length;
  const netBalance = totalIncome - totalExpense;
  const expenseCategories = transactions.filter(t => t.type === 'expense' && t.status === 'approved').reduce((acc, curr) => { acc[curr.category] = (acc[curr.category] || 0) + curr.amount; return acc; }, {});
  const totalApprovedExpense = Object.values(expenseCategories).reduce((a, b) => a + b, 0) || 1;
  const categoryLabels = { service: 'ค่าแรง/บริการ', parts: 'ค่าอะไหล่', tools: 'เครื่องมือช่าง', transport: 'ค่าเดินทาง', welfare: 'สวัสดิการ', other: 'อื่นๆ' };

  if (loading) return <div className="min-h-screen bg-slate-50 flex items-center justify-center"><div className="w-10 h-10 bg-blue-900 rounded-full animate-bounce"></div></div>;

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-24">
      {/* Header */}
      <header className="bg-white shadow-sm sticky top-0 z-20 border-b border-slate-200">
        <div className="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-blue-900 rounded-full flex items-center justify-center text-white font-bold shadow-sm">V</div>
            <div className="leading-tight">
              <h1 className="font-bold text-lg text-slate-800 tracking-tight">Volvo Service</h1>
              <div className={`text-[10px] font-medium flex items-center gap-1 px-2 py-0.5 rounded-full transition-colors ${isConfigured ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-100 text-slate-500'}`}>
                {isConfigured ? (
                    <><CloudLightning size={10} className="text-emerald-500" /> Online</>
                ) : (
                    <><WifiOff size={10} /> Offline Mode</>
                )}
              </div>
            </div>
          </div>
          <button 
                onClick={handleRoleSwitch}
                className={`text-xs px-3 py-1.5 rounded-full transition-all flex items-center gap-1.5 font-medium border ${
                    currentUserRole === 'manager' 
                    ? 'bg-blue-900 text-white border-blue-900 shadow-sm' 
                    : 'bg-slate-100 text-slate-600 border-slate-200'
                }`}
            >
                {currentUserRole === 'manager' ? <Unlock size={12} /> : <Lock size={12} />}
                {currentUserRole === 'manager' ? 'Manager' : 'Staff'}
            </button>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4 space-y-6">
        
        {/* Offline Warning Banner */}
        {!isConfigured && (
            <div className="bg-slate-800 text-slate-200 text-xs p-3 rounded-lg flex justify-between items-center shadow-md">
                <span className="flex items-center gap-2"><Save size={14}/> ข้อมูลบันทึกในเครื่องนี้เท่านั้น</span>
                <span>(กรุณาใส่ Config ในโค้ดเพื่อออนไลน์)</span>
            </div>
        )}

        {/* VIEW: DASHBOARD */}
        {view === 'dashboard' && (
          <div className="space-y-6 animate-in fade-in duration-500">
            {/* Balance Card */}
            <div className="bg-gradient-to-br from-slate-800 via-blue-900 to-slate-900 text-white rounded-2xl p-6 shadow-xl relative overflow-hidden">
              <div className="absolute top-0 right-0 w-40 h-40 bg-white opacity-[0.03] rounded-full -mr-16 -mt-16 blur-2xl"></div>
              <div className="relative z-10">
                <p className="text-slate-300 text-xs font-medium uppercase tracking-wider mb-2">Net Balance</p>
                <h2 className="text-4xl font-bold mb-6 tracking-tight">฿{netBalance.toLocaleString()}</h2>
                
                <div className="grid grid-cols-2 gap-4 pt-4 border-t border-white/10">
                  <div className="bg-emerald-500/10 p-2 rounded-lg border border-emerald-500/20 backdrop-blur-sm">
                    <p className="text-emerald-300 text-[10px] mb-1 flex items-center uppercase tracking-wide"><TrendingUp size={12} className="mr-1"/> Income</p>
                    <p className="font-semibold text-lg text-emerald-100">฿{totalIncome.toLocaleString()}</p>
                  </div>
                  <div className="bg-rose-500/10 p-2 rounded-lg border border-rose-500/20 backdrop-blur-sm">
                    <p className="text-rose-300 text-[10px] mb-1 flex items-center uppercase tracking-wide"><TrendingDown size={12} className="mr-1"/> Expense</p>
                    <p className="font-semibold text-lg text-rose-100">฿{totalExpense.toLocaleString()}</p>
                  </div>
                </div>
              </div>
            </div>

            {/* Quick Stats */}
            <div className="bg-white rounded-xl p-5 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-slate-800 mb-4 flex items-center text-sm">
                    <PieChart size={16} className="mr-2 text-blue-600"/> วิเคราะห์รายจ่าย (อนุมัติแล้ว)
                </h3>
                {Object.keys(expenseCategories).length > 0 ? (
                    <div>
                        {expenseCategories['parts'] && <CategoryBar label="อะไหล่สำรอง" amount={expenseCategories['parts']} total={totalApprovedExpense} colorClass="bg-blue-500" />}
                        {expenseCategories['tools'] && <CategoryBar label="เครื่องมือช่าง" amount={expenseCategories['tools']} total={totalApprovedExpense} colorClass="bg-indigo-500" />}
                        {expenseCategories['transport'] && <CategoryBar label="ค่าเดินทาง" amount={expenseCategories['transport']} total={totalApprovedExpense} colorClass="bg-amber-500" />}
                        {expenseCategories['welfare'] && <CategoryBar label="สวัสดิการ" amount={expenseCategories['welfare']} total={totalApprovedExpense} colorClass="bg-pink-500" />}
                        {expenseCategories['other'] && <CategoryBar label="อื่นๆ" amount={expenseCategories['other']} total={totalApprovedExpense} colorClass="bg-slate-400" />}
                    </div>
                ) : ( <p className="text-center text-slate-400 text-sm py-4">ยังไม่มีรายจ่ายที่อนุมัติ</p> )}
            </div>

            {/* Actions */}
            <div className="grid grid-cols-2 gap-3">
              <button onClick={() => { setModalType('income'); setShowModal(true); }} className="flex flex-col items-center justify-center gap-2 bg-emerald-50 p-4 rounded-xl border border-emerald-100 text-emerald-800"><div className="bg-white p-2 rounded-full shadow-sm text-emerald-600"><PlusCircle size={24} /></div><span className="font-bold text-sm">รับเงินเข้า</span></button>
              <button onClick={() => { setModalType('expense'); setShowModal(true); }} className="flex flex-col items-center justify-center gap-2 bg-rose-50 p-4 rounded-xl border border-rose-100 text-rose-800"><div className="bg-white p-2 rounded-full shadow-sm text-rose-600"><Wallet size={24} /></div><span className="font-bold text-sm">ขอเบิกจ่าย</span></button>
            </div>
          </div>
        )}

        {/* VIEW: REQUESTS */}
        {view === 'requests' && (
          <div className="space-y-4 animate-in slide-in-from-right duration-300">
            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                {['all', 'pending', 'income', 'expense'].map(f => (
                    <button key={f} onClick={() => setFilterType(f)} className={`px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap border transition-colors ${filterType === f ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200'}`}>
                        {f === 'all' && 'ทั้งหมด'}
                        {f === 'pending' && `รออนุมัติ (${pendingCount})`}
                        {f === 'income' && 'รายรับ'}
                        {f === 'expense' && 'รายจ่าย'}
                    </button>
                ))}
            </div>

            <div className="space-y-4">
                {Object.entries(groupTransactionsByDate(getFilteredTransactions())).sort((a,b) => new Date(b[0]) - new Date(a[0])).map(([date, txs]) => (
                    <div key={date}>
                        <h4 className="text-xs font-bold text-slate-400 mb-2 ml-1 flex items-center"><Calendar size={12} className="mr-1"/> {getDateLabel(date)}</h4>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 divide-y divide-slate-100 overflow-hidden">
                            {txs.map(t => (
                                <div key={t.id} className={`p-4 transition-colors ${t.status === 'pending' ? 'bg-amber-50/40' : 'hover:bg-slate-50'}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-start gap-3">
                                            <div className={`w-8 h-8 mt-1 rounded-full flex items-center justify-center shrink-0 text-xs font-bold ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>{t.type === 'income' ? 'IN' : 'OUT'}</div>
                                            <div>
                                                <p className="font-bold text-slate-800 text-sm">{t.title}</p>
                                                <p className="text-xs text-slate-500 mt-0.5 flex items-center gap-1">{t.requester} • <span className="bg-slate-100 px-1.5 py-0.5 rounded text-[10px]">{categoryLabels[t.category] || t.category}</span></p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className={`font-bold text-sm ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-800'}`}>{t.type === 'income' ? '+' : '-'}฿{t.amount.toLocaleString()}</p>
                                            <div className="mt-1 flex justify-end"><StatusBadge status={t.status} /></div>
                                        </div>
                                    </div>
                                    {t.status === 'pending' && currentUserRole === 'manager' && (
                                        <div className="flex gap-2 mt-3 pt-3 border-t border-slate-200/50">
                                            <button onClick={() => handleApprove(t.id)} className="flex-1 bg-emerald-600 text-white text-xs py-2 rounded-lg font-semibold hover:bg-emerald-700 shadow-sm">อนุมัติทันที</button>
                                            <button onClick={() => handleReject(t.id)} className="flex-1 bg-white border border-slate-200 text-slate-600 text-xs py-2 rounded-lg font-medium hover:bg-slate-50">ปฏิเสธ</button>
                                        </div>
                                    )}
                                    {(currentUserRole === 'manager' || (currentUserRole === 'staff' && t.status === 'pending')) && (
                                        <div className="flex justify-end mt-2"><button onClick={() => handleDelete(t.id)} className="text-[10px] text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors"><Trash2 size={12} /> ลบรายการ</button></div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
                {getFilteredTransactions().length === 0 && <div className="text-center py-10"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto text-slate-300 mb-3"><Filter size={24} /></div><p className="text-slate-400 text-sm">ไม่พบรายการ</p></div>}
            </div>
          </div>
        )}
      </main>

      {/* MODALS */}
      {/* Transaction Form Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
          <div className="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-in slide-in-from-bottom duration-200 shadow-2xl">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">{modalType === 'income' ? 'บันทึกรายรับ' : 'ขอเบิกค่าใช้จ่าย'}</h3>
              <button onClick={() => setShowModal(false)} className="bg-slate-100 p-2 rounded-full text-slate-500 hover:bg-slate-200"><XCircle size={20} /></button>
            </div>
            <form onSubmit={handleAddTransaction} className="space-y-4">
              <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">รายการ</label><input name="title" required placeholder="..." className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none" /></div>
              <div className="grid grid-cols-2 gap-4">
                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">จำนวนเงิน</label><input name="amount" type="number" required min="1" placeholder="0.00" className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold" /></div>
                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">หมวดหมู่</label><select name="category" className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    {modalType === 'income' ? <><option value="service">ค่าบริการ</option><option value="parts">ค่าอะไหล่</option><option value="other">อื่นๆ</option></> : <><option value="parts">อะไหล่สำรอง</option><option value="tools">เครื่องมือช่าง</option><option value="transport">ค่าเดินทาง</option><option value="welfare">สวัสดิการ</option><option value="other">เบ็ดเตล็ด</option></>}
                </select></div>
              </div>
              {modalType === 'expense' && (<div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">ผู้ขอเบิก</label><input name="requester" defaultValue={currentUserRole === 'manager' ? "คุณเพิร์ธ (ผจก.)" : ""} placeholder="ชื่อผู้เบิก..." className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50" /></div>)}
              <button type="submit" className={`w-full py-3.5 rounded-xl text-white font-bold shadow-lg mt-2 ${modalType === 'income' ? 'bg-emerald-600' : 'bg-rose-600'}`}>บันทึกรายการ</button>
            </form>
          </div>
        </div>
      )}

      {/* Auth Modal */}
      {showAuthModal && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl">
            <div className="text-center mb-6"><Lock size={32} className="mx-auto text-blue-900 mb-4"/><h3 className="text-lg font-bold">ยืนยันตัวตน</h3><p className="text-xs text-slate-400">ใส่รหัสผ่านเข้าโหมดผู้จัดการ</p></div>
            <form onSubmit={handleAuthSubmit}>
              <input type="password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} className="w-full px-4 py-3 rounded-xl border border-slate-200 text-center text-lg tracking-widest mb-4" placeholder="PIN Code" maxLength={6} autoFocus />
              {authError && <p className="text-red-500 text-xs text-center mb-2">{authError}</p>}
              <div className="flex gap-2"><button type="button" onClick={() => setShowAuthModal(false)} className="flex-1 py-2 rounded-xl border border-slate-200 text-sm">ยกเลิก</button><button type="submit" className="flex-1 py-2 rounded-xl bg-blue-900 text-white text-sm font-bold">ยืนยัน</button></div>
            </form>
          </div>
        </div>
      )}

      {/* Bottom Nav */}
      <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 px-6 py-2 flex justify-around items-center text-slate-400 max-w-md mx-auto z-40 pb-safe">
        <button className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${view === 'dashboard' ? 'text-blue-900 bg-blue-50' : ''}`} onClick={() => setView('dashboard')}><PieChart size={24} strokeWidth={view === 'dashboard'?2.5:2}/><span className="text-[10px] font-bold">ภาพรวม</span></button>
        <div className="w-px h-8 bg-slate-200"></div>
        <button className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${view === 'requests' ? 'text-blue-900 bg-blue-50' : ''}`} onClick={() => setView('requests')}><div className="relative"><Activity size={24} strokeWidth={view === 'requests'?2.5:2}/>{pendingCount > 0 && <span className="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>}</div><span className="text-[10px] font-bold">กิจกรรม</span></button>
      </div>
      <div className="h-6 bg-white/90 max-w-md mx-auto fixed bottom-0 left-0 right-0 z-30"></div>

      {/* Components Definition (Reused) */}
      {/* ... (CategoryBar, StatusBadge are reused implicitly by rendering logic above) ... */}
    </div>
  );
};

// Helper Components
const CategoryBar = ({ label, amount, total, colorClass }) => {
    const percent = Math.min((amount / total) * 100, 100);
    return (<div className="mb-3"><div className="flex justify-between text-xs mb-1"><span className="text-slate-600 font-medium">{label}</span><span className="text-slate-800 font-bold">{Math.round(percent)}% (฿{amount.toLocaleString()})</span></div><div className="w-full bg-slate-100 rounded-full h-2"><div className={`h-2 rounded-full ${colorClass}`} style={{ width: `${percent}%` }}></div></div></div>);
};
const StatusBadge = ({ status }) => {
    const styles = { approved: 'bg-emerald-100 text-emerald-700 border-emerald-200', pending: 'bg-amber-100 text-amber-700 border-amber-200', rejected: 'bg-red-100 text-red-700 border-red-200' };
    const labels = { approved: 'อนุมัติ', pending: 'รออนุมัติ', rejected: 'ปัดตก' };
    return (<span className={`text-[10px] px-1.5 py-0.5 rounded border font-medium ${styles[status]}`}>{labels[status]}</span>);
};

export default App;