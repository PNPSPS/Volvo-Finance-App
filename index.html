<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volvo Finance Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f1f5f9; background-image: url('https://images.unsplash.com/photo-1625047509168-a7026f36de04?q=80&w=2564&auto=format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; min-height: 100vh; }
        #app-container { background-color: rgba(255, 255, 255, 0.85); min-height: 100vh; backdrop-filter: blur(8px); padding-bottom: 80px; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .hidden { display: none !important; }
        .btn-press:active { transform: scale(0.95); }
        /* Modal Animation */
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- 1. LOADING SCREEN -->
        <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-white z-50">
            <div class="text-center text-slate-500 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>

        <!-- 2. CONFIG SCREEN -->
        <div id="config-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                <h2 class="text-xl font-bold mb-4 text-center">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h2>
                <textarea id="config-input" class="w-full h-40 p-3 border rounded-xl mb-4 text-xs font-mono bg-slate-50" placeholder='‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î firebaseConfig ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...'></textarea>
                <div id="config-error" class="text-red-500 text-xs mb-2 hidden"></div>
                <button onclick="saveConfig()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>

        <!-- 3. LOGIN SCREEN -->
        <div id="login-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
            <div class="w-full max-w-lg mb-10 text-center">
                <div class="w-20 h-20 bg-gradient-to-tr from-blue-700 to-slate-800 rounded-3xl flex items-center justify-center mx-auto mb-5 shadow-xl text-white text-4xl font-bold">V</div>
                <h1 class="text-3xl font-bold text-slate-800">Volvo Finance</h1>
                <p class="text-slate-600 mt-1">Service Center Management</p>
            </div>
            
            <div id="user-grid" class="grid grid-cols-2 gap-4 w-full max-w-sm mb-6">
                <!-- User cards will be injected here -->
            </div>
            
            <div class="text-center mt-6">
                <button onclick="restoreAdmin()" class="text-xs text-slate-400 underline">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Restore Admin)</button>
            </div>
        </div>

        <!-- 4. PIN MODAL -->
        <div id="pin-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-3xl w-full max-w-xs text-center shadow-2xl modal-enter">
                <div id="pin-user-avatar" class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 font-bold text-2xl"></div>
                <h3 class="font-bold text-xl mb-1 text-slate-800">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h3>
                <p id="pin-user-name" class="text-slate-500 mb-8 font-medium"></p>
                <input type="password" id="pin-input" maxlength="6" class="w-full text-center text-4xl tracking-[0.5em] border-b-2 border-slate-200 focus:border-blue-500 outline-none py-2 mb-8 bg-transparent font-mono" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <div class="flex gap-3">
                    <button onclick="closeModal('pin-modal')" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="verifyPin()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </div>

        <!-- 5. MAIN APP SCREEN -->
        <div id="main-app" class="hidden">
            <header class="bg-white/90 backdrop-blur-md px-4 py-3 sticky top-0 shadow-sm flex justify-between items-center z-20">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-700 w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-md">V</div>
                    <div>
                        <h1 class="font-bold text-slate-800">Volvo Finance</h1>
                        <div id="current-user-display" class="text-xs text-slate-500 font-medium"></div>
                    </div>
                </div>
                <button onclick="logout()" class="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
            </header>

            <main class="p-4 space-y-6 max-w-md mx-auto">
                <!-- Balance Card -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 rounded-[2rem] shadow-2xl relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 text-slate-400 text-xs font-bold tracking-wider mb-4">SERVICE FUND</div>
                        <div id="balance-display" class="text-5xl font-bold tracking-tight">‡∏ø0.00</div>
                        <div class="text-slate-400 text-xs mt-2">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                    </div>
                    <div class="absolute right-0 top-0 w-40 h-40 bg-blue-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openModal('request-modal')" class="glass-card p-5 rounded-2xl flex items-center gap-4 btn-press">
                        <div class="bg-blue-50 text-blue-600 w-12 h-12 rounded-2xl flex items-center justify-center shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
                        <div class="text-left"><div class="font-bold text-slate-800">‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</div><div class="text-xs text-slate-500">Request</div></div>
                    </button>
                    <button id="btn-deposit" onclick="openModal('deposit-modal')" class="glass-card p-5 rounded-2xl flex items-center gap-4 btn-press hidden">
                        <div class="bg-emerald-50 text-emerald-600 w-12 h-12 rounded-2xl flex items-center justify-center shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
                        <div class="text-left"><div class="font-bold text-slate-800">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div><div class="text-xs text-slate-500">Deposit</div></div>
                    </button>
                </div>

                <!-- Manager Tools -->
                <div id="manager-tools" class="hidden grid grid-cols-2 gap-4">
                    <button onclick="switchTab('approvals')" class="bg-amber-50 border border-amber-200 p-4 rounded-2xl flex justify-between items-center text-amber-800 btn-press">
                        <span class="font-bold text-sm">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                        <span id="pending-count" class="bg-amber-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                    </button>
                    <button onclick="openModal('manage-modal')" class="glass-card p-4 rounded-2xl flex justify-between items-center text-slate-700 btn-press">
                        <span class="font-bold text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </button>
                </div>

                <!-- Income Breakdown -->
                <div id="income-breakdown" class="glass-card rounded-[2rem] p-5 hidden">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg> ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div id="breakdown-list" class="space-y-3"></div>
                </div>

                <!-- Lists Container -->
                <div class="glass-card rounded-[2rem] overflow-hidden">
                    <div class="bg-white/50 p-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 id="list-title" class="font-bold text-slate-700 flex items-center gap-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                        <div id="tab-controls" class="flex gap-2">
                            <button onclick="switchTab('dashboard')" class="text-xs px-3 py-1 rounded-full bg-blue-100 text-blue-700">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
                            <button onclick="switchTab('myRequests')" class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏â‡∏±‡∏ô</button>
                        </div>
                    </div>
                    <div id="main-list" class="divide-y divide-slate-100 max-h-96 overflow-y-auto">
                        <!-- Items injected here -->
                    </div>
                </div>
            </main>
        </div>

        <!-- MODALS (Hidden by default) -->
        <!-- Request Modal -->
        <div id="request-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 rounded-3xl w-full max-w-sm shadow-2xl modal-enter">
                <h3 class="font-bold text-xl mb-4">‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <input id="req-desc" class="w-full border p-4 rounded-xl mb-3 bg-slate-50" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢">
                <input id="req-amount" type="number" class="w-full border p-4 rounded-xl mb-6 bg-slate-50 text-lg" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
                <div class="flex gap-3">
                    <button onclick="closeModal('request-modal')" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="submitRequest()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                </div>
            </div>
        </div>

        <!-- Deposit Modal -->
        <div id="deposit-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 rounded-3xl w-full max-w-sm shadow-2xl modal-enter">
                <h3 class="font-bold text-xl mb-4">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <select id="dep-cat" class="w-full border p-4 rounded-xl mb-3 bg-slate-50">
                    <option value="scrap">‚ôªÔ∏è ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤/‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•</option>
                    <option value="contribution">ü§ù ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏ó‡∏ö/‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ</option>
                    <option value="fine">‚ö†Ô∏è ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö</option>
                    <option value="activity">üéâ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                    <option value="other">üì¶ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
                <input id="dep-desc" class="w-full border p-4 rounded-xl mb-3 bg-slate-50" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
                <input id="dep-amount" type="number" class="w-full border p-4 rounded-xl mb-6 bg-slate-50 text-lg" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
                <div class="flex gap-3">
                    <button onclick="closeModal('deposit-modal')" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="submitDeposit()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                </div>
            </div>
        </div>

        <!-- Register Modal -->
        <div id="register-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 rounded-3xl w-full max-w-sm shadow-2xl modal-enter">
                <h3 class="font-bold text-xl mb-4">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h3>
                <input id="reg-name" class="w-full border p-4 rounded-xl mb-3 bg-slate-50" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
                <div class="flex gap-2 mb-3">
                    <button onclick="setRegRole('staff')" id="role-staff" class="flex-1 py-2 border rounded-xl bg-blue-50 border-blue-500 text-blue-700 font-bold">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                    <button onclick="setRegRole('manager')" id="role-manager" class="flex-1 py-2 border rounded-xl text-slate-500">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
                </div>
                <input id="reg-pin" class="w-full border p-4 rounded-xl mb-6 bg-slate-50 text-center text-lg tracking-widest" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™ PIN 4 ‡∏´‡∏•‡∏±‡∏Å" maxlength="4">
                <div class="flex gap-3">
                    <button onclick="closeModal('register-modal')" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="submitRegister()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                </div>
            </div>
        </div>

        <!-- Manage User Modal -->
        <div id="manage-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 rounded-3xl w-full max-w-sm shadow-2xl h-[80vh] flex flex-col modal-enter">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="font-bold text-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                    <button onclick="closeModal('manage-modal')">‚úï</button>
                </div>
                <div id="manage-list" class="flex-1 overflow-y-auto space-y-3"></div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // üü¢ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ Config ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        // ==========================================
        const HARDCODED_CONFIG = {apiKey:"AIzaSyAmm8CJj4yU6Qclr1_l8yVwcQptOtnh0rE",authDomain:"volvo-finance.firebaseapp.com",projectId:"volvo-finance",storageBucket:"volvo-finance.firebasestorage.app",messagingSenderId:"713687952336",appId:"1:713687952336:web:00b6a228b36098cf5fe7d5",measurementId:"G-HFEWYL8GZ9"};

        // --- GLOBAL VARIABLES ---
        let db, auth;
        let currentUser = null;
        let selectedUser = null; // For PIN login
        let currentRegRole = 'staff';
        let appData = { users: [], transactions: [], requests: [] };
        let currentTab = 'dashboard';
        const appId = 'volvo-finance';

        // --- INIT ---
        window.onload = function() {
            const savedConfig = localStorage.getItem('vfs_config');
            const config = HARDCODED_CONFIG || (savedConfig ? JSON.parse(savedConfig) : null);

            if (config) {
                initFirebase(config);
            } else {
                showScreen('config-screen');
            }
        };

        function initFirebase(config) {
            try {
                if (!firebase.apps.length) firebase.initializeApp(config);
                auth = firebase.auth();
                db = firebase.firestore();
                
                auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log("Connected");
                        startListening();
                    } else {
                        auth.signInAnonymously().catch(e => alert("Auth Error: " + e.message));
                    }
                });
            } catch (e) {
                alert("Config Error: " + e.message);
                localStorage.removeItem('vfs_config');
                window.location.reload();
            }
        }

        function saveConfig() {
            const input = document.getElementById('config-input').value.trim();
            try {
                let clean = input.replace(/^(const|var|let)\s+firebaseConfig\s*=\s*/, '').replace(/;$/, '');
                const json = new Function('return ' + clean)();
                if(!json.apiKey) throw new Error("Invalid Config");
                
                localStorage.setItem('vfs_config', JSON.stringify(json));
                window.location.reload();
            } catch (e) {
                document.getElementById('config-error').innerText = "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Object JSON)";
                document.getElementById('config-error').classList.remove('hidden');
            }
        }

        // --- DATA LISTENING ---
        function startListening() {
            // Listen Users
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                .onSnapshot(snap => {
                    appData.users = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderLoginScreen();
                    if(currentUser) renderApp();
                });

            // Listen Transactions
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('transactions')
                .orderBy('createdAt', 'desc').limit(50)
                .onSnapshot(snap => {
                    appData.transactions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(currentUser) renderApp();
                });

            // Listen Requests
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('requests')
                .orderBy('createdAt', 'desc').limit(50)
                .onSnapshot(snap => {
                    appData.requests = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(currentUser) renderApp();
                });
            
            showScreen('login-screen');
        }

        // --- RENDER FUNCTIONS ---
        function showScreen(id) {
            ['loading-screen', 'config-screen', 'login-screen', 'main-app'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function renderLoginScreen() {
            const grid = document.getElementById('user-grid');
            grid.innerHTML = '';
            
            // Add Active Users
            appData.users.filter(u => u.status === 'active').forEach(u => {
                const btn = document.createElement('button');
                btn.className = 'bg-white p-4 rounded-xl shadow-sm border hover:border-blue-500 flex flex-col items-center transition-all btn-press';
                btn.onclick = () => openPinModal(u);
                btn.innerHTML = `
                    <div class="w-14 h-14 bg-slate-100 rounded-full flex items-center justify-center font-bold text-xl text-slate-600 mb-2">${u.name[0]}</div>
                    <div class="font-bold text-slate-800">${u.name}</div>
                    <div class="text-xs text-slate-400 uppercase">${u.role}</div>
                `;
                grid.appendChild(btn);
            });

            // Add Register Button
            const regBtn = document.createElement('button');
            regBtn.className = 'bg-white/50 border-2 border-dashed border-slate-300 p-4 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:bg-white hover:text-blue-600 transition-all btn-press';
            regBtn.onclick = () => openModal('register-modal');
            regBtn.innerHTML = `<span class="text-3xl mb-1">+</span><span class="text-sm font-bold">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</span>`;
            grid.appendChild(regBtn);
        }

        function renderApp() {
            if(!currentUser) return;
            
            // Header
            document.getElementById('current-user-display').innerText = `${currentUser.name} (${currentUser.role})`;
            
            // Balance
            const balance = appData.transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            document.getElementById('balance-display').innerText = new Intl.NumberFormat('th-TH', {style:'currency', currency:'THB'}).format(balance);

            // Conditional UI
            const isManager = currentUser.role === 'manager';
            document.getElementById('btn-deposit').classList.toggle('hidden', !isManager);
            document.getElementById('manager-tools').classList.toggle('hidden', !isManager);

            // Pending Counts
            const pendingReqs = appData.requests.filter(r => r.status === 'pending');
            const pendingUsers = appData.users.filter(u => u.status === 'pending');
            const pCount = document.getElementById('pending-count');
            if(pendingReqs.length > 0 || pendingUsers.length > 0) {
                pCount.innerText = pendingReqs.length + pendingUsers.length;
                pCount.classList.remove('hidden');
            } else {
                pCount.classList.add('hidden');
            }

            // List Content
            const listContainer = document.getElementById('main-list');
            listContainer.innerHTML = '';
            
            let items = [];
            if (currentTab === 'dashboard') {
                document.getElementById('list-title').innerHTML = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
                document.getElementById('income-breakdown').classList.remove('hidden');
                items = appData.transactions;
                renderBreakdown();
            } else if (currentTab === 'approvals') {
                document.getElementById('list-title').innerHTML = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                document.getElementById('income-breakdown').classList.add('hidden');
                items = pendingReqs;
            } else {
                document.getElementById('list-title').innerHTML = '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô';
                document.getElementById('income-breakdown').classList.add('hidden');
                items = appData.requests.filter(r => r.requesterId === currentUser.id);
            }

            if(items.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
            } else {
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-4 flex justify-between items-center hover:bg-slate-50 transition-colors';
                    
                    if (currentTab === 'approvals') { // Approval View
                        div.className = 'p-4 bg-amber-50 border-b border-amber-100';
                        div.innerHTML = `
                            <div class="w-full">
                                <div class="flex justify-between mb-2">
                                    <div><div class="font-bold text-slate-800">${item.description}</div><div class="text-xs text-slate-500">‡πÇ‡∏î‡∏¢ ${item.requester}</div></div>
                                    <div class="font-bold text-lg">${formatMoney(item.amount)}</div>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="processReq('${item.id}', 'approved')" class="flex-1 bg-emerald-500 text-white py-2 rounded-lg text-sm font-bold shadow-sm">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                    <button onclick="processReq('${item.id}', 'rejected')" class="flex-1 bg-white border text-slate-600 py-2 rounded-lg text-sm font-bold">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                </div>
                            </div>
                        `;
                    } else { // Normal View
                        const isIncome = item.type === 'income';
                        const color = isIncome ? 'text-emerald-600' : 'text-slate-800';
                        const iconBg = isIncome ? 'bg-emerald-100' : 'bg-slate-100';
                        // Handle pending/rejected status display for My History
                        let statusBadge = '';
                        if(item.status) {
                            const badgeColor = item.status === 'pending' ? 'bg-amber-100 text-amber-700' : item.status === 'approved' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700';
                            statusBadge = `<span class="text-[10px] px-2 py-0.5 rounded ${badgeColor} ml-2 uppercase">${item.status}</span>`;
                        }

                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${iconBg}">
                                    ${isIncome ? '+' : '-'}
                                </div>
                                <div>
                                    <div class="font-bold text-sm text-slate-800 flex items-center">${item.description} ${statusBadge}</div>
                                    <div class="text-xs text-slate-400">${item.performer || item.requester} ‚Ä¢ ${new Date(item.createdAt?.seconds*1000).toLocaleDateString('th-TH')}</div>
                                </div>
                            </div>
                            <div class="font-bold ${color}">${isIncome ? '+' : '-'}${formatMoney(item.amount)}</div>
                        `;
                    }
                    listContainer.appendChild(div);
                });
            }

            // Render Manage Users List
            if(!document.getElementById('manage-modal').classList.contains('hidden')) {
                renderManageList();
            }
        }

        function renderBreakdown() {
            const breakdown = {};
            appData.transactions.forEach(t => {
                if(t.type === 'income') {
                    const cat = t.category || 'other';
                    breakdown[cat] = (breakdown[cat] || 0) + t.amount;
                }
            });
            const totalIncome = Object.values(breakdown).reduce((a,b)=>a+b, 0);
            const container = document.getElementById('breakdown-list');
            container.innerHTML = '';
            
            const cats = [
                {id: 'scrap', label: '‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•', icon: '‚ôªÔ∏è'},
                {id: 'contribution', label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏ó‡∏ö', icon: 'ü§ù'},
                {id: 'fine', label: '‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö', icon: '‚ö†Ô∏è'},
                {id: 'activity', label: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', icon: 'üéâ'},
                {id: 'other', label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', icon: 'üì¶'}
            ];

            if(totalIncome === 0) {
                container.innerHTML = '<div class="text-xs text-slate-400 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>';
                return;
            }

            cats.forEach(c => {
                const amt = breakdown[c.id] || 0;
                if(amt > 0) {
                    const pct = ((amt/totalIncome)*100).toFixed(0);
                    container.innerHTML += `
                        <div class="flex justify-between items-center text-sm">
                            <div class="flex items-center gap-2"><span class="bg-white p-1 rounded-md shadow-sm">${c.icon}</span> <span>${c.label}</span></div>
                            <div class="flex gap-3"><span class="font-bold">${formatMoney(amt)}</span> <span class="text-slate-400 text-xs w-8 text-right">${pct}%</span></div>
                        </div>
                        <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden mb-2"><div class="bg-indigo-500 h-full" style="width:${pct}%"></div></div>
                    `;
                }
            });
        }

        function renderManageList() {
            const container = document.getElementById('manage-list');
            container.innerHTML = '';
            appData.users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 border rounded-xl bg-slate-50';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center font-bold text-slate-500 shadow-sm border">${u.name[0]}</div>
                        <div>
                            <div class="font-bold text-slate-800">${u.name} ${currentUser.id === u.id ? '<span class="text-blue-600 text-xs">(‡∏â‡∏±‡∏ô)</span>' : ''}</div>
                            <div class="text-xs text-slate-500 uppercase">${u.role} ‚Ä¢ ${u.status}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        ${u.status === 'pending' ? `<button onclick="updateUserStatus('${u.id}', 'active')" class="p-2 bg-emerald-100 text-emerald-600 rounded-lg">‚úî</button>` : ''}
                        ${currentUser.id !== u.id ? `<button onclick="deleteUser('${u.id}')" class="p-2 bg-white border border-rose-200 text-rose-500 rounded-lg">üóë</button>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- ACTIONS ---
        function openPinModal(u) {
            selectedUser = u;
            document.getElementById('pin-user-name').innerText = u.name;
            document.getElementById('pin-user-avatar').innerText = u.name[0];
            document.getElementById('pin-input').value = '';
            openModal('pin-modal');
            document.getElementById('pin-input').focus();
        }

        function verifyPin() {
            const pin = document.getElementById('pin-input').value;
            if(pin === selectedUser.pin) {
                currentUser = selectedUser;
                closeModal('pin-modal');
                showScreen('main-app');
                renderApp();
            } else {
                alert("‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                document.getElementById('pin-input').value = '';
            }
        }

        function logout() {
            currentUser = null;
            showScreen('login-screen');
        }

        function switchTab(tab) {
            currentTab = tab;
            renderApp();
        }

        function setRegRole(role) {
            currentRegRole = role;
            document.getElementById('role-staff').className = role === 'staff' ? 'flex-1 py-2 border rounded-xl bg-blue-50 border-blue-500 text-blue-700 font-bold' : 'flex-1 py-2 border rounded-xl text-slate-500';
            document.getElementById('role-manager').className = role === 'manager' ? 'flex-1 py-2 border rounded-xl bg-blue-50 border-blue-500 text-blue-700 font-bold' : 'flex-1 py-2 border rounded-xl text-slate-500';
        }

        async function submitRegister() {
            const name = document.getElementById('reg-name').value;
            const pin = document.getElementById('reg-pin').value;
            if(!name || pin.length < 4) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                    name, role: currentRegRole, pin, status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥");
                closeModal('register-modal');
            } catch(e) { alert("Error: " + e.message); }
        }

        async function restoreAdmin() {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á User: ‡πÄ‡∏û‡∏¥‡∏£‡πå‡∏ò (Manager) ‡∏£‡∏´‡∏±‡∏™ 2121?')) return;
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                    name: '‡πÄ‡∏û‡∏¥‡∏£‡πå‡∏ò', role: 'manager', pin: '2121', status: 'active', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch(e) { alert("Error: " + e.message); }
        }

        async function submitRequest() {
            const desc = document.getElementById('req-desc').value;
            const amount = document.getElementById('req-amount').value;
            if(!desc || !amount) return;
            
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('requests').add({
                description: desc, amount: parseFloat(amount), requester: currentUser.name, requesterId: currentUser.id, status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp(), type: 'expense'
            });
            closeModal('request-modal');
        }

        async function submitDeposit() {
            const desc = document.getElementById('dep-desc').value;
            const amount = document.getElementById('dep-amount').value;
            const cat = document.getElementById('dep-cat').value;
            if(!amount) return;

            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('transactions').add({
                description: desc || '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ï‡∏¥‡∏°', amount: parseFloat(amount), category: cat, performer: currentUser.name, type: 'income', createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal('deposit-modal');
        }

        async function processReq(id, status) {
            const req = appData.requests.find(r => r.id === id);
            if(status === 'approved') {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('transactions').add({
                    description: req.description, amount: parseFloat(req.amount), performer: req.requester, approver: currentUser.name, type: 'expense', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('requests').doc(id).update({status});
        }

        async function updateUserStatus(id, status) {
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(id).update({status});
        }

        async function deleteUser(id) {
            if(confirm("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?")) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(id).delete();
        }

        // --- UTILS ---
        function formatMoney(n) { return new Intl.NumberFormat('th-TH', {style:'currency', currency:'THB'}).format(n); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>